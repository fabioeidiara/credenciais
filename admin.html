<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Admin – CETESB Credenciais</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="style.css?v=248" rel="stylesheet">
  <meta name="color-scheme" content="light">
  <link rel="icon" href="data:,">
  <style>
    .label-like{ font-size:12px; color:#64748b; }
    .file-row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .file-row .btn{ margin:0 }
  </style>
</head>
<body>
<header class="header">
  <div class="container">
    <div class="brand">
      <img src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1>CETESB – Administração de Credenciais</h1>
    </div>
    <div class="actions">
      <a class="btn" href="consulta.html">Consulta</a>
      <button class="btn" id="btnChangePass">Trocar senha</button>
      <button class="btn danger" id="btnSair">Sair</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="grid grid-2">
    <!-- ESQUERDA: FORM -->
    <section class="card pad">
      <h2 class="card-title">Cadastro</h2>

      <form class="form" id="formCad" autocomplete="off">
        <div class="field">
          <label for="registro" class="req">Registro</label>
          <input id="registro" class="input" placeholder="000001" maxlength="6" pattern="[0-9]{6}" required>
        </div>

        <div class="field">
          <label for="nome" class="req">Nome</label>
          <input id="nome" class="input" required>
        </div>

        <div class="field">
          <label for="sigla" class="req">Unidade</label>
          <select id="sigla" class="input" required></select>
        </div>

        <div class="field">
          <label for="cred_cod" class="req">Tipo</label>
          <select id="cred_cod" class="input" required></select>
        </div>

        <div class="field">
          <label for="cred_num" class="req">Número</label>
          <input id="cred_num" class="input" maxlength="4" pattern="[0-9]{1,4}" required>
        </div>

        <div class="field">
          <label for="validade" class="req">Validade</label>
          <input id="validade" class="input" type="date" required>
        </div>

        <div class="field">
          <label for="status" class="req">Status</label>
          <select id="status" class="input" required>
            <option>Em andamento</option>
            <option>Ativo</option>
            <option>Inativo</option>
          </select>
        </div>

        <div class="field">
          <label for="doe">DOE (nº-ano)</label>
          <input id="doe" class="input" placeholder="12345-2025" pattern="^\\d{1,6}\\-\\d{4}$">
        </div>

        <div class="field">
          <label>Foto</label>
          <div class="row" style="gap:12px;align-items:center;flex-wrap:wrap">
            <img id="preview" alt="Prévia da foto" width="120" height="120" style="border-radius:8px;object-fit:cover;border:1px solid #ddd">
            <div class="file-row">
              <input id="arquivoFoto" type="file" accept="image/*" style="display:none">
              <button type="button" class="btn" id="btnEscolherArquivo">Selecionar foto</button>
              <button type="button" class="btn danger" id="btnRemoverFoto">Remover foto</button>
            </div>
          </div>
        </div>

        <div class="row-actions">
          <button id="btnNovo" type="button" class="btn">Novo</button>
          <button id="btnExcluir" type="button" class="btn danger">Excluir</button>
          <button id="btnQR" type="button" class="btn">Gerar QR</button>
          <button id="btnSalvar" type="submit" class="btn primary">Salvar</button>
        </div>
      </form>
    </section>

    <!-- DIREITA: LISTA -->
    <section class="card pad">
      <h2 class="card-title">Lista e filtros</h2>

      <div class="row" style="gap:10px;align-items:flex-start;flex-wrap:wrap">
        <input id="q" class="input" style="flex:1 1 220px" placeholder="Buscar por nome, registro, número">
        <input id="f_numero" class="input" style="width:120px" placeholder="Número">
        <select id="f_status" class="input" style="min-width:140px">
          <option value="">Todos</option>
          <option>Ativo</option>
          <option>Em andamento</option>
          <option>Inativo</option>
        </select>
        <select id="f_sigla" class="input" style="min-width:140px"></select>

        <div id="tiposBox" class="card" style="padding:8px 10px;border-radius:10px;display:flex;gap:8px;flex-wrap:wrap"></div>

        <button id="btnReload" class="btn">Recarregar</button>
      </div>

      <div class="scroll">
        <table class="table">
          <thead>
            <tr>
              <th style="width:56px">Foto</th>
              <th>Registro</th>
              <th>Nome</th>
              <th>Unidade</th>
              <th>Número</th>
              <th>Tipo</th>
              <th>Validade</th>
              <th>Status</th>
              <th style="width:140px">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="count" class="label-like">0 registro(s)</div>
    </section>
  </div>
</main>

<footer class="footer"><div class="container">Piloto – CETESB</div></footer>

<script type="module">
  // ===== Helpers =====
  function $(s){ return document.querySelector(s); }
  function fmt(iso){ return iso ? new Date(iso).toLocaleDateString('pt-BR') : ''; }

  // Placeholders embutidos
  var PH120 = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%25' height='100%25' fill='%23eef2f7' rx='12' ry='12'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='12' fill='%2390a4b8'>sem foto</text></svg>";
  var PH40  = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect width='100%25' height='100%25' fill='%23eef2f7' rx='8' ry='8'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='16' fill='%2390a4b8'>?</text></svg>";
  $('#preview').src = PH120;

  // Sair / Trocar senha
  $('#btnSair')?.addEventListener('click', function(){ localStorage.removeItem('sessaoUsuario'); location.href='index.html'; });
  $('#btnChangePass')?.addEventListener('click', function(){ location.href='change-password.html'; });

  // Arquivo
  $('#btnEscolherArquivo').addEventListener('click', function(){ $('#arquivoFoto').click(); });
  $('#arquivoFoto').addEventListener('change', function(ev){
    var f = ev.target.files && ev.target.files[0];
    if(!f){ $('#preview').src = PH120; return; }
    $('#preview').src = URL.createObjectURL(f);
  });

  // ===== config.json =====
  var cfg;
  try{
    var r = await fetch('config.json', { cache:'no-store' });
    if(!r.ok) throw new Error('config.json HTTP '+r.status);
    var txt = await r.text();
    try{ cfg = JSON.parse(txt); }catch(e){ console.error('config.json inválido:', txt); alert('config.json inválido'); throw e; }
  }catch(e){ console.error(e); alert('Falha ao carregar config.json'); throw e; }

  // ===== Supabase =====
  const supa = await import('https://esm.sh/@supabase/supabase-js@2');
  const createClient = supa.createClient;
  var supabase = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);

  function normalizeFotoPath(p){ return String(p||'').replace(/^fotos\//i,''); }
  function splitDir(basepath){
    var i = basepath.lastIndexOf('/');
    return i === -1 ? { dir:'', name:basepath } : { dir:basepath.slice(0,i), name:basepath.slice(i+1) };
  }
  async function objectExists(bucket, fullpath){
    var t = splitDir(fullpath);
    var res = await supabase.storage.from(bucket).list(t.dir || '', { search: t.name, limit: 1 });
    if(res.error) return false;
    return (res.data||[]).some(function(x){ return x.name === t.name; });
  }
  async function getFotoUrlIfExists(path){
    var bucket = cfg.storageBucket || 'fotos';
    var ok = await objectExists(bucket, path);
    if(!ok) return null;
    var s = await supabase.storage.from(bucket).createSignedUrl(path, 3600);
    if(s && !s.error && s.data && s.data.signedUrl) return s.data.signedUrl;
    var p = supabase.storage.from(bucket).getPublicUrl(path);
    if(p && p.data && p.data.publicUrl) return p.data.publicUrl;
    return null;
  }
  async function getFotoUrlFlexible(reg, foto_path){
    var candidates = [];
    if (foto_path) candidates.push(normalizeFotoPath(foto_path));
    candidates.push(reg + '.png', reg + '.jpg', reg + '.jpeg');
    for (var i=0;i<candidates.length;i++){
      var url = await getFotoUrlIfExists(candidates[i]);
      if(url) return url;
    }
    return null;
  }

  // ===== Combos =====
  // Cache de sigla -> nome_da_unidade para cumprir NOT NULL
  var UNITS_MAP = Object.create(null);

  async function carregarCombos(){
    var resU = await supabase.from('unidades').select('sigla,nome_da_unidade').order('sigla');
    var resC = await supabase.from('credenciais').select('cred_cod,descricao').order('cred_cod');

    var u = resU.data || [], c = resC.data || [];

    // popula selects
    $('#sigla').innerHTML    = u.map(function(x){ 
      UNITS_MAP[x.sigla] = x.nome_da_unidade || ''; 
      return '<option value="'+x.sigla+'">'+x.sigla+' – '+(x.nome_da_unidade||'')+'</option>'; 
    }).join('');
    $('#cred_cod').innerHTML = c.map(function(x){ return '<option value="'+x.cred_cod+'">'+x.cred_cod+' – '+(x.descricao||'')+'</option>'; }).join('');
    document.getElementById('f_sigla').innerHTML  = '<option value="">Todas</option>'+u.map(function(x){ return '<option value="'+x.sigla+'">'+x.sigla+'</option>'; }).join('');

    // tipos (checkboxes)
    var tipos = document.getElementById('tiposBox');
    tipos.innerHTML = '<span class="label-like">Tipo:</span>' + (c.data||[]).map(function(x){
      return '<label class="label-like" style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" class="f_tipo" value="'+x.cred_cod+'"> '+x.cred_cod+'</label>';
    }).join('');
  }

  function filtrosTiposSelecionados(){
    return Array.prototype.slice.call(document.querySelectorAll('.f_tipo:checked')).map(function(el){ return el.value; });
  }

  // ===== Lista =====
  async function carregarLista(){
    var q = document.getElementById('q').value.trim();
    var fs = document.getElementById('f_status').value;
    var fSig = document.getElementById('f_sigla').value;
    var fNum = document.getElementById('f_numero').value.trim();
    var fTipos = filtrosTiposSelecionados();

    var query = supabase.from('empregados').select('registro,nome,sigla,cred_num,cred_cod,validade,status,foto_path').order('registro');

    if(q){
      var isNum = /^\d+$/.test(q);
      query = isNum ? query.or('registro.eq.'+q+',cred_num.eq.'+q) : query.ilike('nome', '%'+q+'%');
    }
    if(fs)   query = query.eq('status', fs);
    if(fSig) query = query.eq('sigla', fSig);
    if(fNum) query = query.eq('cred_num', fNum);
    if(fTipos.length) query = query.in('cred_cod', fTipos.map(Number));

    var res = await query;
    if(res.error){ console.error(res.error); alert('Erro ao carregar lista'); return; }
    var data = res.data || [];

    var linhas = await Promise.all(data.map(async function(x){
      var fotoUrl = await getFotoUrlFlexible(x.registro, x.foto_path);
      var avatar = fotoUrl || PH40;

      var ok = (x.status==='Ativo' && x.validade && new Date(x.validade) >= new Date(new Date().toDateString()));
      var chip = ok ? '<span class="chip success">Ativo</span>' :
                (x.status==='Em andamento' ? '<span class="chip warn">Em andamento</span>' :
                                              '<span class="chip danger">Inativo</span>');

      return '<tr data-reg="'+x.registro+'">'+
        '<td><img src="'+avatar+'" alt="foto" width="40" height="40" style="border-radius:6px;object-fit:cover;border:1px solid #ddd" onerror="this.src=\''+PH40+'\'"></td>'+
        '<td>'+x.registro+'</td>'+
        '<td>'+(x.nome||'')+'</td>'+
        '<td>'+(x.sigla||'')+'</td>'+
        '<td>'+(x.cred_num||'')+'</td>'+
        '<td>'+(x.cred_cod||'')+'</td>'+
        '<td>'+fmt(x.validade)+'</td>'+
        '<td>'+chip+'</td>'+
        '<td><button class="btn sm" data-acao="editar">Editar</button> <a class="btn sm" target="_blank" href="public.html?reg='+x.registro+'">Público</a></td>'+
      '</tr>';
    }));

    document.getElementById('tbody').innerHTML = linhas.join('') || '<tr><td colspan="9" class="muted">Nenhum registro</td></tr>';
    document.getElementById('count').textContent = String(data.length)+' registro(s)';
  }

  // ===== Editar → form =====
  document.getElementById('tbody').addEventListener('click', async function(ev){
    var btn = ev.target.closest && ev.target.closest('[data-acao="editar"]');
    if(!btn) return;
    var tr = ev.target.closest('tr'); var reg = tr && tr.getAttribute('data-reg'); if(!reg) return;

    var res = await supabase.from('empregados').select('*').eq('registro', reg).maybeSingle();
    if(res.error){ alert('Erro ao carregar registro'); return; }
    var d = res.data || {};

    document.getElementById('registro').value  = d.registro || '';
    document.getElementById('nome').value      = d.nome || '';
    document.getElementById('sigla').value     = d.sigla || '';
    document.getElementById('cred_cod').value  = d.cred_cod || '';
    document.getElementById('cred_num').value  = d.cred_num || '';
    document.getElementById('validade').value  = d.validade ? String(d.validade).slice(0,10) : '';
    document.getElementById('status').value    = d.status || 'Em andamento';
    document.getElementById('doe').value       = d.doe || '';

    var url = await getFotoUrlFlexible(d.registro, d.foto_path);
    document.getElementById('preview').src = url || PH120;
    document.getElementById('arquivoFoto').value='';
  });

  // ===== Remover foto =====
  document.getElementById('btnRemoverFoto').addEventListener('click', async function(){
    var reg = document.getElementById('registro').value.trim();
    if(!/^\d{6}$/.test(reg)) return alert('Informe um registro válido (6 dígitos).');

    var cur = await supabase.from('empregados').select('foto_path').eq('registro', reg).maybeSingle();
    var key = normalizeFotoPath(cur.data && cur.data.foto_path);
    var bucket = cfg.storageBucket || 'fotos';
    if(key){ try{ await supabase.storage.from(bucket).remove([key]); }catch(_){} }
    await supabase.from('empregados').update({ foto_path: null }).eq('registro', reg);

    document.getElementById('preview').src = PH120;
    document.getElementById('arquivoFoto').value='';
  });

  // ===== Salvar (upload integrado) =====
  async function uploadFotoSeHouver(reg){
    var file = document.getElementById('arquivoFoto').files && document.getElementById('arquivoFoto').files[0];
    if(!file) return null;
    var ext = (file.name.split('.').pop() || 'png').toLowerCase();
    var key = reg+'.'+ext;
    var bucket = cfg.storageBucket || 'fotos';
    var contentType = file.type || (ext==='png'?'image/png':(ext==='jpg' || ext==='jpeg')?'image/jpeg':'application/octet-stream');

    var up = await supabase.storage.from(bucket).upload(key, file, { upsert:true, contentType });
    if(up.error){ throw new Error(up.error.message || 'Falha no upload da foto'); }
    return key;
  }

  document.getElementById('formCad').addEventListener('submit', async function(ev){
    ev.preventDefault();

    var reg = document.getElementById('registro').value.trim();
    if(!/^\d{6}$/.test(reg)) return alert('Registro inválido (6 dígitos).');

    var sig = document.getElementById('sigla').value;
    var nomeUn = UNITS_MAP[sig]; // <- capturamos o nome_da_unidade a partir da sigla
    if(!nomeUn){ 
      // fallback de segurança (não deve ocorrer porque combos vêm de 'unidades')
      var ru = await supabase.from('unidades').select('nome_da_unidade').eq('sigla', sig).maybeSingle();
      nomeUn = (ru && ru.data && ru.data.nome_da_unidade) || '';
    }

    var payload = {
      registro: reg,
      nome: document.getElementById('nome').value.trim(),
      sigla: sig,
      nome_da_unidade: nomeUn,            // <- **AGORA PREENCHIDO** (evita NOT NULL)
      cred_cod: Number(document.getElementById('cred_cod').value),
      cred_num: document.getElementById('cred_num').value.trim(),
      validade: document.getElementById('validade').value,
      status: document.getElementById('status').value,
      doe: document.getElementById('doe').value.trim() || null
    };

    try{
      // 1) sobe foto se houver, e injeta foto_path para salvar junto
      var fotoKey = await uploadFotoSeHouver(reg);
      if(fotoKey) payload.foto_path = fotoKey;

      // 2) upsert do registro
      var resp = await supabase.from('empregados').upsert(payload, { onConflict:'registro' });
      if(resp.error) throw new Error(resp.error.message || 'Erro ao salvar');

      // 3) atualiza prévia e limpa input de arquivo
      if(fotoKey){
        var url = await getFotoUrlFlexible(reg, fotoKey);
        document.getElementById('preview').src = url || PH120;
        document.getElementById('arquivoFoto').value='';
      }

      await carregarLista();
      alert('Registro salvo com sucesso.');
    }catch(err){
      console.error(err);
      alert('Falha ao salvar: '+(err && err.message ? err.message : String(err)));
    }
  });

  // ===== Interações filtros =====
  document.getElementById('btnReload').addEventListener('click', carregarLista);
  document.getElementById('q').addEventListener('input', function(){ clearTimeout(window._deb); window._deb=setTimeout(carregarLista,250); });
  document.getElementById('f_sigla').addEventListener('change', carregarLista);
  document.getElementById('f_status').addEventListener('change', carregarLista);
  document.getElementById('f_numero').addEventListener('input', function(){ clearTimeout(window._deb2); window._deb2=setTimeout(carregarLista,250); });
  document.getElementById('tiposBox').addEventListener('change', carregarLista);

  // ===== Init =====
  await carregarCombos();
  await carregarLista();
</script>
</body>
</html>
