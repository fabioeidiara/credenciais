<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>CETESB – Administração de Credenciais</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="style.css" rel="stylesheet">
  <meta name="color-scheme" content="light">
  <link rel="icon" href="data:,">
  <style>
    /* Cabeçalho: logo, título e botões */
    .brand-logo{ max-height:28px; width:auto; display:block; }
    .title{ font-size:22px; line-height:1.25; margin:0; }
    .topbar-bar{ display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .topbar-left{ display:flex; align-items:center; gap:10px; }
    .topbar-right{ display:flex; align-items:center; gap:10px; }

    /* Ordenação por cabeçalho (sem ícones) */
    th.sortable{ cursor:pointer; user-select:none }
    th.sortable:hover{ text-decoration: underline dotted }

    /* Placeholders/microtexto */
    .label-like{ font-size:12px; color:#64748b }
    .input::placeholder{ color:#a8b3c0; opacity:1 }
  </style>
</head>
<body>

<header class="topbar">
  <div class="container topbar-bar">
    <div class="topbar-left">
      <img class="brand-logo" src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1 class="title">CETESB – Administração de Credenciais</h1>
    </div>
    <div class="topbar-right">
      <a class="btn" href="consulta.html">Consulta</a>
      <button class="btn" id="btnChangePass">Trocar senha</button>
      <button class="btn danger" id="btnSair">Sair</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="grid grid-2">
    <!-- ESQUERDA: formulário -->
    <section class="card pad">
      <h2 class="card-title">Cadastro</h2>

      <form id="formCad" class="form" autocomplete="off">
        <div class="field">
          <label for="registro" class="req">Registro</label>
          <input id="registro" class="input" placeholder="000001" maxlength="6" pattern="[0-9]{6}" required>
        </div>

        <div class="field">
          <label for="nome" class="req">Nome</label>
          <input id="nome" class="input" required>
        </div>

        <div class="field">
          <label for="sigla" class="req">Unidade</label>
          <select id="sigla" class="input" required></select>
        </div>

        <div class="field">
          <label for="cred_cod" class="req">Tipo</label>
          <select id="cred_cod" class="input" required></select>
        </div>

        <div class="field">
          <label for="cred_num" class="req">Número</label>
          <input id="cred_num" class="input" maxlength="4" pattern="[0-9]{1,4}" required>
        </div>

        <div class="field">
          <label for="validade" class="req">Validade</label>
          <input id="validade" class="input" type="date" required>
        </div>

        <div class="field">
          <label for="status" class="req">Status</label>
          <select id="status" class="input" required>
            <option>Em andamento</option>
            <option>Ativo</option>
            <option>Inativo</option>
          </select>
        </div>

        <div class="field">
          <label for="doe">DOE (nº-ano)</label>
          <input id="doe" class="input" placeholder="12345-2025" pattern="^\\d{1,6}\\-\\d{4}$">
        </div>

        <div class="field">
          <label>Foto</label>
          <div class="row" style="gap:12px;align-items:center;flex-wrap:wrap">
            <img id="preview" alt="Prévia da foto" width="120" height="120" style="border:1px solid #ddd;border-radius:8px;object-fit:cover">
            <div class="row" style="gap:8px;flex-wrap:wrap">
              <input id="arquivoFoto" type="file" accept="image/*" style="display:none">
              <button type="button" class="btn" id="btnEscolherArquivo">Selecionar foto</button>
              <button type="button" class="btn danger" id="btnRemoverFoto">Remover foto</button>
            </div>
          </div>
        </div>

        <div class="row-actions">
          <button id="btnNovo" type="button" class="btn">Novo</button>
          <button id="btnExcluir" type="button" class="btn danger">Excluir</button>
          <button id="btnQR" type="button" class="btn">Gerar QR</button>
          <button id="btnSalvar" type="submit" class="btn primary">Salvar</button>
        </div>
      </form>
    </section>

    <!-- DIREITA: lista -->
    <section class="card pad">
      <h2 class="card-title">Lista e filtros</h2>

      <div class="row" style="gap:10px;flex-wrap:wrap;align-items:flex-end">
        <div class="col">
          <label class="label-like" for="f_nome">Nome</label>
          <input id="f_nome" class="input" placeholder="Ex.: MARIA">
        </div>
        <div class="col">
          <label class="label-like" for="f_reg">Matrícula</label>
          <input id="f_reg" class="input" placeholder="Ex.: 000123" maxlength="6">
        </div>
        <div class="col">
          <label class="label-like" for="f_numero">Número (credencial)</label>
          <input id="f_numero" class="input" placeholder="Ex.: 0042" maxlength="4">
        </div>
        <div class="col">
          <label class="label-like" for="f_status">Status</label>
          <select id="f_status" class="input">
            <option value="">Todos</option>
            <option>Ativo</option>
            <option>Em andamento</option>
            <option>Inativo</option>
          </select>
        </div>
        <div class="col">
          <label class="label-like" for="f_sigla">Unidade</label>
          <select id="f_sigla" class="input"></select>
        </div>

        <div class="col" style="flex:1 1 100%">
          <span class="label-like">Tipo</span>
          <div id="tiposBox" class="row" style="gap:10px;flex-wrap:wrap"><span class="label-like">carregando…</span></div>
        </div>

        <div class="row" style="gap:12px;width:100%;justify-content:center">
          <button id="btnReload" class="btn">Recarregar</button>
          <button id="btnQrSelecionados" class="btn">QR em lote</button>
        </div>
      </div>

      <div class="scroll">
        <table class="table" id="tabela">
          <thead>
            <tr>
              <th style="width:34px"><input id="chkAll" type="checkbox" title="Marcar todos"></th>
              <th style="width:56px">Foto</th>
              <th class="sortable" data-col="registro">Matrícula</th>
              <th class="sortable" data-col="nome">Nome</th>
              <th class="sortable" data-col="sigla">Unidade</th>
              <th class="sortable" data-col="cred_num">Número</th>
              <th class="sortable" data-col="cred_cod">Tipo</th>
              <th class="sortable" data-col="validade">Validade</th>
              <th class="sortable" data-col="status">Status</th>
              <th style="width:140px">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="count" class="label-like">0 registro(s)</div>
    </section>
  </div>
</main>

<footer class="footer">
  <div class="container">Piloto – CETESB</div>
</footer>

<script type="module">
  import QRCode from 'https://esm.sh/qrcode@1.5.3';
  const supa = await import('https://esm.sh/@supabase/supabase-js@2');

  const $=(s)=>document.querySelector(s);
  const fmt=(iso)=>iso?new Date(iso).toLocaleDateString('pt-BR'):'';
  const PH120="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%25' height='100%25' fill='%23eef2f7' rx='12' ry='12'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='12' fill='%2390a4b8'>sem foto</text></svg>";
  const PH40 ="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect width='100%25' height='100%25' fill='%23eef2f7' rx='8' ry='8'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='16' fill='%2390a4b8'>?</text></svg>";
  $('#preview').src=PH120;

  /* ---------- Status exibido (única fonte para filtro/ordenação) ---------- */
  function normStatus(s){
    return String(s ?? '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();
  }
  function displayStatus(rec){
    const raw = normStatus(rec.status);
    const hoje = new Date(new Date().toDateString());
    if (raw === 'ativo') {
      const ok = rec.validade && new Date(rec.validade) >= hoje;
      return ok ? 'Ativo' : 'Inativo';
    }
    if (raw === 'em andamento') return 'Em andamento';
    return 'Inativo';
  }
  function statusChip(label){
    if (label === 'Ativo') return '<span class="chip success">Ativo</span>';
    if (label === 'Em andamento') return '<span class="chip warn">Em andamento</span>';
    return '<span class="chip danger">Inativo</span>';
  }

  // ordenação atual
  let sortCol='registro';
  let sortAsc=true;

  // nav
  $('#btnSair')?.addEventListener('click',()=>{localStorage.removeItem('sessaoUsuario');location.href='index.html';});
  $('#btnChangePass')?.addEventListener('click',()=>{location.href='change-password.html';});

  // arquivo → preview
  $('#btnEscolherArquivo').addEventListener('click',()=>$('#arquivoFoto').click());
  $('#arquivoFoto').addEventListener('change',(ev)=>{
    const f=ev.target.files?.[0];
    $('#preview').src=f?URL.createObjectURL(f):PH120;
  });

  // config & supabase
  let cfg;{
    const r=await fetch('config.json',{cache:'no-store'});
    if(!r.ok){alert('Falha ao carregar config.json');throw new Error('config.json HTTP '+r.status);}
    cfg=await r.json();
  }
  const supabase=supa.createClient(cfg.supabaseUrl,cfg.supabaseAnonKey);

  // helpers foto
  const UNITS_MAP=Object.create(null);
  const normalize=(p)=>String(p||'').replace(/^fotos\//i,'');
  const splitDir=(b)=>{const i=b.lastIndexOf('/');return i===-1?{dir:'',name:b}:{dir:b.slice(0,i),name:b.slice(i+1)};}
  async function objExists(bucket,full){const t=splitDir(full);const r=await supabase.storage.from(bucket).list(t.dir||'',{search:t.name,limit:1});if(r.error)return false;return (r.data||[]).some(x=>x.name===t.name);}
  async function getFotoUrlIfExists(path){const bucket=cfg.storageBucket||'fotos';if(!await objExists(bucket,path))return null;const s=await supabase.storage.from(bucket).createSignedUrl(path,3600);if(s?.data?.signedUrl)return s.data.signedUrl;const p=supabase.storage.from(bucket).getPublicUrl(path);return p?.data?.publicUrl||null;}
  async function getFotoUrlFlexible(reg,foto_path,{strict=false}={}){const list=[];if(foto_path){list.push(normalize(foto_path));if(!strict){list.push(reg+'.png',reg+'.jpg',reg+'.jpeg')}}else if(!strict){list.push(reg+'.png',reg+'.jpg',reg+'.jpeg')}for(const k of list){const u=await getFotoUrlIfExists(k);if(u)return u}return null;}
  async function removeOtherExtAfterUpload(reg,keepKey){const keep=normalize(keepKey);const bucket=cfg.storageBucket||'fotos';const all=[reg+'.png',reg+'.jpg',reg+'.jpeg'];const toRemove=all.filter(k=>k!==keep);try{await supabase.storage.from(bucket).remove(toRemove)}catch{}}
  async function deleteAllKnownPhotos(reg,currentKey){const bucket=cfg.storageBucket||'fotos';const keys=[reg+'.png',reg+'.jpg',reg+'.jpeg'];if(currentKey){const cur=normalize(currentKey);if(!keys.includes(cur))keys.push(cur)}try{await supabase.storage.from(bucket).remove(keys)}catch{}}
  async function uploadFotoSeHouver(reg){const file=$('#arquivoFoto').files?.[0];if(!file)return null;const ext=(file.name.split('.').pop()||'png').toLowerCase();const key=`${reg}.${ext}`;const bucket=cfg.storageBucket||'fotos';const contentType=file.type||(ext==='png'?'image/png':(ext==='jpg'||ext==='jpeg')?'image/jpeg':'application/octet-stream');const up=await supabase.storage.from(bucket).upload(key,file,{upsert:true,contentType});if(up.error)throw new Error(up.error.message||'Falha no upload da foto');await removeOtherExtAfterUpload(reg,key);return key;}

  // combos
  async function carregarCombos(){
    const [u,c]=await Promise.all([
      supabase.from('unidades').select('sigla,nome_da_unidade').order('sigla'),
      supabase.from('credenciais').select('cred_cod,descricao').order('cred_cod')
    ]);
    const un=u.data||[], cr=c.data||[];
    $('#sigla')?.insertAdjacentHTML('beforeend',''); // (admin somente; aqui não há)
    $('#f_sigla').innerHTML=`<option value="">Todas</option>`+un.map(x=>`<option value="${x.sigla}">${x.sigla}</option>`).join('');
    const tipos=$('#tiposBox'); tipos.innerHTML = cr.length ? cr.map(x=>`<label class="label-like" style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" class="f_tipo" value="${x.cred_cod}"> ${x.cred_cod}</label>`).join('') : `<span class="label-like">Nenhum tipo cadastrado</span>`;
  }
  const tiposSelecionados=()=>Array.from(document.querySelectorAll('.f_tipo:checked')).map(el=>el.value);

  // ordenar cabeçalhos
  function bindSortHeaders(){
    document.querySelectorAll('th.sortable').forEach(th=>{
      th.onclick=()=>{const col=th.getAttribute('data-col');if(!col)return; if(sortCol===col) sortAsc=!sortAsc; else {sortCol=col;sortAsc=true;} carregarLista();}
    });
  }

  /* ------------------------- LISTA ------------------------- */
  async function carregarLista(){
    const nome=$('#f_nome').value.trim();
    const regPart=$('#f_reg').value.trim();
    const numPart=$('#f_numero').value.trim();
    const fSig=$('#f_sigla').value;
    const fTipos=tiposSelecionados();

    let query=supabase.from('empregados').select('registro,nome,sigla,cred_num,cred_cod,validade,status,foto_path');
    if(nome) query=query.ilike('nome',`%${nome}%`);
    if(fSig) query=query.eq('sigla',fSig);
    if(fTipos.length) query=query.in('cred_cod', fTipos.map(Number));

    if (sortCol !== 'status') {
      query = query.order(sortCol,{ascending:sortAsc});
    }
    query = query.order('registro',{ascending:true});

    const res=await query;
    if(res.error){console.error(res.error);alert('Erro ao carregar lista');return;}
    let data=res.data||[];

    // Filtro de status (com base no status exibido)
    const fs = ($('#f_status').value||'').trim();
    if (fs) data = data.filter(r => displayStatus(r) === fs);

    // Buscas parciais locais
    if(regPart) data=data.filter(x=>String(x.registro||'').includes(regPart));
    if(numPart) data=data.filter(x=>String(x.cred_num||'').includes(numPart));

    // Ordenação por status (client-side) quando solicitado
    if (sortCol === 'status') {
      data.sort((a,b)=>{
        const sa = displayStatus(a);
        const sb = displayStatus(b);
        const cmp = sa.localeCompare(sb,'pt-BR');
        return sortAsc ? cmp : -cmp;
      });
    }

    const linhas=await Promise.all(data.map(async x=>{
      const url=await getFotoUrlFlexible(x.registro,x.foto_path,{strict:!x.foto_path});
      const avatar=url||PH40;
      const dlabel = displayStatus(x);
      const chip = statusChip(dlabel);
      return `<tr>
        <td><img src="${avatar}" width="40" height="40" style="border-radius:6px;object-fit:cover;border:1px solid #ddd" onerror="this.src='${PH40}'"></td>
        <td>${x.registro}</td>
        <td>${x.nome||''}</td>
        <td>${x.sigla||''}</td>
        <td>${x.cred_num||''}</td>
        <td>${x.cred_cod||''}</td>
        <td>${fmt(x.validade)}</td>
        <td>${chip}</td>
        <td><a class="btn sm" target="_blank" href="public.html?reg=${x.registro}">Público</a></td>
      </tr>`;
    }));
    $('#tbody').innerHTML=linhas.join('')||'<tr><td colspan="9" class="label-like">Nenhum registro</td></tr>';
    $('#count').textContent=String(data.length)+' registro(s)';
  }

  // eventos
  $('#btnReload')?.addEventListener('click',carregarLista);
  $('#f_sigla').addEventListener('change',carregarLista);
  $('#f_status').addEventListener('change',carregarLista);
  ['f_numero','f_reg','f_nome'].forEach(id=>$('#'+id).addEventListener('input',()=>{clearTimeout(window['_deb'+id]);window['_deb'+id]=setTimeout(carregarLista,250);} ));
  document.addEventListener('change',(e)=>{if(e.target?.classList?.contains('f_tipo'))carregarLista();});

  bindSortHeaders();
  await carregarCombos();
  await carregarLista();
</script>
</body>
</html>
