<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Admin – CETESB Credenciais</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="style.css" rel="stylesheet">
</head>
<body>

<header class="header">
  <div class="container">
    <div class="brand">
      <img src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1>CETESB – Administração de Credenciais</h1>
    </div>
    <div class="actions">
      <a class="btn" href="consulta.html">Consulta</a>
      <button id="btnSair" class="btn danger">Sair</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="grid grid-2">
    <!-- COLUNA ESQUERDA: FORMULÁRIO -->
    <section class="card pad">
      <h2 class="card-title">Cadastro</h2>

      <form class="form" id="formCad" autocomplete="off">
        <div class="field">
          <label for="registro" class="req">Registro (6 dígitos)</label>
          <input id="registro" class="input" placeholder="000001" maxlength="6" pattern="\\d{6}" required>
        </div>

        <div class="row">
          <div class="field">
            <label for="cred_num" class="req">Nº da credencial</label>
            <input id="cred_num" class="input" placeholder="2025-000123" required>
          </div>
          <div class="field">
            <label for="status" class="req">Status</label>
            <select id="status" class="select" required>
              <option value="Ativo">Ativo</option>
              <option value="Em andamento">Em andamento</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label for="nome" class="req">Nome</label>
          <input id="nome" class="input" required>
        </div>

        <div class="row">
          <div class="field">
            <label for="sigla" class="req">Sigla da unidade</label>
            <!-- agora é select, preenchido de 'unidades' -->
            <select id="sigla" class="select" required>
              <option value="">Selecione…</option>
            </select>
          </div>
          <div class="field">
            <label for="validade" class="req">Validade da credencial</label>
            <input id="validade" class="input" type="date" required>
          </div>
        </div>

        <div class="field">
          <label for="nome_da_unidade">Nome da unidade</label>
          <input id="nome_da_unidade" class="input" placeholder="Preenchido pela sigla" readonly>
        </div>

        <div class="field">
          <label for="doe">Diário Oficial do Estado (DOE)</label>
          <input id="doe" class="input" placeholder="Nº/ano (opcional)">
        </div>

        <div class="field">
          <label for="cred_cod" class="req">Código da credencial</label>
          <select id="cred_cod" class="select" required></select>
        </div>

        <div class="row">
          <div class="field">
            <label for="fotoInput">Foto (upload)</label>
            <input id="fotoInput" class="input" type="file" accept=".jpg,.jpeg,.png">
            <a id="linkIntra" class="small" target="_blank" rel="noopener" href="javascript:void(0)" aria-disabled="true">Quem é Quem</a>
          </div>
          <div class="field">
            <label>Pré-visualização</label>
            <img id="preview" class="avatar" alt="Prévia" src="" onerror="this.src='https://via.placeholder.com/120x120?text=pre%CC%81via'">
          </div>
        </div>

        <div class="row right">
          <button id="btnNovo" type="button" class="btn">Novo</button>
          <button id="btnExcluir" type="button" class="btn danger">Excluir</button>
          <button id="btnQR" type="button" class="btn">Gerar QR</button>
          <button id="btnSalvar" type="submit" class="btn primary">Salvar</button>
        </div>
      </form>
    </section>

    <!-- COLUNA DIREITA: LISTA E FILTROS -->
    <section class="card pad">
      <h2 class="card-title">Lista e filtros</h2>

      <div class="toolbar mb-12">
        <input id="q" class="input grow" placeholder="Buscar por nome, registro...">
        <select id="f_sigla" class="select">
          <option value="">— Sigla —</option>
        </select>
        <select id="f_status" class="select">
          <option value="">— Status —</option>
          <option value="Ativo">Ativo</option>
          <option value="Em andamento">Em andamento</option>
          <option value="Inativo">Inativo</option>
        </select>
        <button id="btnReload" class="btn">Recarregar</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Registro</th>
              <th>Nome</th>
              <th>Sigla</th>
              <th>Validade</th>
              <th>Status</th>
              <th class="right">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="count" class="small muted mt-8">0 registro(s)</div>
    </section>
  </div>

  <div id="toast" class="toast hidden alert success"><div id="toastMsg">OK</div></div>
</main>

<script type="module">
  // --- Utilitários UI ---
  const $ = (s)=>document.querySelector(s);
  const show = (el, v=true)=> el.classList.toggle('hidden', !v);
  const toast = (t, kind='success')=>{
    const el = $('#toast'); const m = $('#toastMsg');
    el.className = 'toast alert '+(kind==='error'?'error':kind==='warn'?'warn':'success');
    m.textContent = t; show(el, true); setTimeout(()=>show(el,false), 2000);
  };

  // --- Config ---
  let cfg;
  try{
    const res = await fetch('config.json', { cache:'no-store' });
    if(!res.ok) throw new Error('config.json '+res.status);
    cfg = await res.json();
  }catch(e){ alert('Falha ao carregar config.json'); throw e; }

  // --- Supabase client ---
  const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
  const supabase = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);

  // --- Autenticação: exige login ---
  const { data: { user } } = await supabase.auth.getUser();
  if(!user){ location.href = cfg.loginPage || 'index.html'; throw new Error('sem login'); }

  // --- Sair ---
  $('#btnSair').addEventListener('click', async ()=>{
    await supabase.auth.signOut(); location.href = cfg.loginPage || 'index.html';
  });

  // ---------- Helpers ----------
  const todayZero = ()=>{
    const d = new Date(); return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  };
  const isVigente = (validadeISO)=>{
    if(!validadeISO) return false;
    const [y,m,d] = validadeISO.split('-').map(Number);
    const V = new Date(y, m-1, d);
    return V >= todayZero();
  };
  const statusDerivado = (row)=>{
    // prioridade: Em andamento (sempre amarelo)
    if (row.status === 'Em andamento') return {label:'Em andamento', cls:'andamento'};
    // caso contrário, só "Ativo" com validade >= hoje fica verde
    if (row.status === 'Ativo' && isVigente(row.validade)) return {label:'Ativo', cls:'ativo'};
    return {label:'Inativo', cls:'inativo'};
  };
  const fmtDataISOtoBR = (iso)=> !iso ? '—' : (()=>{ const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}` })();

  // ---------- Carregar combos auxiliares ----------
  // CREDENCIAIS
  const credSel = $('#cred_cod');
  (async ()=>{
    const { data, error } = await supabase.from('credenciais').select('cred_cod,descricao').order('cred_cod');
    if(!error && data){
      credSel.innerHTML = data.map(c=>`<option value="${c.cred_cod}">${c.cred_cod} — ${c.descricao}</option>`).join('');
    }
  })();

  // UNIDADES (mapa para autopreencher e população do select)
  const unidadesMap = new Map();
  (async ()=>{
    const { data, error } = await supabase.from('unidades').select('sigla,nome_da_unidade').order('sigla');
    if(!error && data){
      const sel = $('#sigla');
      sel.innerHTML = '<option value="">Selecione…</option>' + data.map(u=>`<option value="${u.sigla}">${u.sigla}</option>`).join('');
      data.forEach(u=> unidadesMap.set((u.sigla||'').toUpperCase(), u));
      sel.addEventListener('change', ()=>{
        const key = (sel.value||'').toUpperCase();
        const u = unidadesMap.get(key);
        $('#nome_da_unidade').value = u ? (u.nome_da_unidade||'') : '';
      });
    }
  })();

  // ---------- Link da intranet (auto) ----------
  function regToEmpr(reg6){
    const n = Math.max(0, parseInt((reg6||'').replace(/\D/g,''),10) || 0);
    return String(n).padStart(4,'0'); // 008031 -> 8031 -> "8031" -> pad 4 => "8031"
  }
  const linkIntra = $('#linkIntra');
  function updateLinkIntra(){
    const reg = $('#registro').value.trim();
    if (/^\d{6}$/.test(reg)){
      const code = regToEmpr(reg);
      const url = `http://sistemasintra01/QuemQuem/fotos/empr-${code}.jpg`;
      linkIntra.href = url;
      linkIntra.setAttribute('aria-disabled','false');
      // se não houver upload nem foto salva, tentar mostrar a intranet na prévia (em rede interna)
      if (!$('#fotoInput').files?.length && !$('#preview').dataset.locked) {
        $('#preview').src = url;
      }
    } else {
      linkIntra.href = 'javascript:void(0)';
      linkIntra.setAttribute('aria-disabled','true');
    }
  }
  $('#registro').addEventListener('input', updateLinkIntra);
  $('#registro').addEventListener('blur', updateLinkIntra);

  // ---------- Pré-visualização da foto escolhida ----------
  $('#fotoInput').addEventListener('change', (ev)=>{
    const f = ev.target.files?.[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    $('#preview').src = url;
    // trava a prévia no arquivo local até salvar/substituir
    $('#preview').dataset.locked = '1';
  });

  // ---------- CRUD / Lista ----------
  let editing = null;

  async function carregarLista(){
    const q = ($('#q').value||'').trim().toLowerCase();
    const fSigla = $('#f_sigla').value||'';
    const fStatus = $('#f_status').value||'';

    let query = supabase.from('empregados')
      .select('registro,nome,sigla,validade,status', { count:'exact' })
      .order('registro', { ascending: true });

    if (fSigla) query = query.eq('sigla', fSigla);
    if (fStatus) {
      // filtro por derivação: precisamos filtrar client-side se for "Inativo" por validade
      const { data, error } = await query;
      if (error){ console.error(error); toast('Erro ao carregar lista','error'); return; }
      const rows = (data||[]).filter(r=>{
        const sd = statusDerivado(r).label;
        return sd === fStatus;
      });
      renderTabela(rows);
      $('#count').textContent = `${rows.length} registro(s)`;
      return;
    }

    if (q){ query = query.or(`nome.ilike.%${q}%,registro.ilike.%${q}%`); }

    const { data, error, count } = await query;
    if (error){ console.error(error); toast('Erro ao carregar lista','error'); return; }
    renderTabela(data||[]);
    $('#count').textContent = `${count||0} registro(s)`;
  }

  function renderTabela(rows){
    const tbody = $('#tbody');
    tbody.innerHTML = rows.map(r=>{
      const sd = statusDerivado(r);
      return `
        <tr>
          <td>${r.registro}</td>
          <td>${r.nome||'—'}</td>
          <td>${r.sigla||'—'}</td>
          <td>${fmtDataISOtoBR(r.validade)||'—'}</td>
          <td><span class="chip ${sd.cls}">${sd.label}</span></td>
          <td class="right table-actions">
            <button class="btn" data-edit="${r.registro}">Editar</button>
            <a class="btn" target="_blank" rel="noopener" href="public.html?reg=${r.registro}">Abrir pública</a>
          </td>
        </tr>
      `;
    }).join('');

    tbody.querySelectorAll('button[data-edit]').forEach(btn=>{
      btn.addEventListener('click', ()=> editar(btn.getAttribute('data-edit')));
    });
  }

  async function editar(registro){
    const { data, error } = await supabase.from('empregados')
      .select('registro,cred_num,cred_cod,status,nome,sigla,nome_da_unidade,validade,doe,foto_path')
      .eq('registro', registro).maybeSingle();
    if (error || !data){ toast('Erro ao abrir registro','error'); return; }

    editing = data.registro;
    $('#formCad').reset();
    $('#preview').dataset.locked = '';
    // preencher form
    $('#registro').value = data.registro||'';
    $('#cred_num').value = data.cred_num||'';
    $('#status').value = data.status||'Ativo';
    $('#nome').value = data.nome||'';
    $('#sigla').value = data.sigla||'';
    $('#validade').value = data.validade||'';
    $('#nome_da_unidade').value = data.nome_da_unidade||'';
    $('#doe').value = data.doe||'';
    $('#cred_cod').value = String(data.cred_cod||'');

    // Link intranet + prévia
    updateLinkIntra();
    if (data.foto_path) {
      $('#preview').src = `${cfg.supabaseUrl}/storage/v1/object/public/${data.foto_path}`;
      $('#preview').dataset.locked = '1';
    } else {
      // tenta intranet (em rede interna)
      const reg = $('#registro').value.trim();
      if (/^\d{6}$/.test(reg)) {
        const url = `http://sistemasintra01/QuemQuem/fotos/empr-${regToEmpr(reg)}.jpg`;
        $('#preview').src = url;
      } else {
        $('#preview').src = 'https://via.placeholder.com/120x120?text=pre%CC%81via';
      }
    }
    toast('Registro carregado');
  }

  // Botões topo lista
  $('#btnReload').addEventListener('click', carregarLista);
  $('#q').addEventListener('input', ()=>{ clearTimeout(window._t); window._t=setTimeout(carregarLista,350); });
  $('#f_sigla').addEventListener('change', carregarLista);
  $('#f_status').addEventListener('change', carregarLista);

  // Novo
  $('#btnNovo').addEventListener('click', ()=>{
    editing = null;
    $('#formCad').reset();
    $('#preview').dataset.locked = '';
    $('#preview').src = 'https://via.placeholder.com/120x120?text=pre%CC%81via';
    updateLinkIntra();
    toast('Cadastro limpo');
  });

  // Excluir
  $('#btnExcluir').addEventListener('click', async ()=>{
    const reg = $('#registro').value.trim();
    if(!/^\d{6}$/.test(reg)){ alert('Informe um registro válido.'); return; }
    if(!confirm(`Excluir ${reg}?`)) return;
    const { error } = await supabase.from('empregados').delete().eq('registro', reg);
    if(error){ toast('Erro ao excluir','error'); return; }
    try{ await supabase.storage.from(cfg.storageBucket||'fotos').remove([`fotos/${reg}.jpg`, `fotos/${reg}.png`]); }catch(e){}
    $('#btnNovo').click();
    carregarLista();
    toast('Excluído.');
  });

  // Gerar QR
  $('#btnQR').addEventListener('click', ()=>{
    const reg = $('#registro').value.trim();
    if(!/^\d{6}$/.test(reg)){ alert('Informe um registro válido.'); return; }
    const url = `${cfg.BASE_URL.replace(/\/$/,'')}/${cfg.publicPage||'public.html'}?reg=${reg}`;
    window.open(`https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(url)}`,'_blank','noopener');
  });

  // Salvar
  $('#formCad').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const registro = $('#registro').value.trim();
    const cred_num = $('#cred_num').value.trim();
    const status   = $('#status').value.trim();
    const nome     = $('#nome').value.trim();
    const sigla    = $('#sigla').value.trim().toUpperCase();
    const validade = $('#validade').value || null;
    const nome_da_unidade = $('#nome_da_unidade').value.trim();
    const doe      = ($('#doe').value||'').trim() || null;
    const cred_cod = parseInt($('#cred_cod').value||'0',10) || null;

    if (!/^\d{6}$/.test(registro)){ alert('Registro deve ter 6 dígitos.'); return; }
    if (!nome || !sigla || !cred_cod){ alert('Preencha Nome, Sigla e Código da credencial.'); return; }

    const payload = { registro, cred_num, cred_cod, status, nome, sigla, nome_da_unidade, validade, doe };

    const { error } = await supabase.from('empregados').upsert(payload, { onConflict:'registro' });
    if (error){ console.error(error); toast('Erro ao salvar','error'); return; }

    // Upload da foto (opcional)
    const file = $('#fotoInput').files?.[0];
    if (file){
      const ext = (file.name.split('.').pop()||'jpg').toLowerCase();
      const path = `fotos/${registro}.${ext}`;
      try{ await supabase.storage.from(cfg.storageBucket||'fotos').remove([`fotos/${registro}.jpg`,`fotos/${registro}.png`]); }catch(e){}
      const up = await supabase.storage.from(cfg.storageBucket||'fotos').upload(path, file, { upsert:true, cacheControl:'3600' });
      if (up.error){ console.warn('upload falhou', up.error); }
      await supabase.from('empregados').update({ foto_path: path }).eq('registro', registro);
      $('#preview').dataset.locked = '1';
      $('#preview').src = `${cfg.supabaseUrl}/storage/v1/object/public/${path}`;
    }

    toast('Salvo com sucesso.');
    carregarLista();
  });

  // Inicialização
  updateLinkIntra();
  carregarLista();
</script>

</body>
</html>
