<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>CETESB – Administração de Credenciais</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="style.css" rel="stylesheet">
  <meta name="color-scheme" content="light">
  <link rel="icon" href="data:,">
    <style>
    :root{
      /* tamanhos/cores padronizados p/ TODOS os títulos e labels */
      --title-size: 16px;       /* menor que antes */
      --title-weight: 700;
      --title-color: #3f4b5a;   /* azul-acinzentado suave (igual vibe do 1º painel) */
  
      --label-size: 13px;       /* menor e consistente */
      --label-weight: 600;
      --label-color: #6b7787;   /* cinza MAIS CLARO, como você pediu */
  
      /* layout já usado anteriormente */
      --cell-pad-x: 14px;
      --first-col-w: 34px;      /* coluna checkbox */
      --foto-col-w: 56px;       /* coluna foto  */
      --radius-xl: 16px;
      --line: #e5e9f1;
      --muted: #64748b;
      --muted-2: #94a3b8;
    }
  
    .container{ max-width:1200px; margin:0 auto; padding:0 16px; }
    .card{ background:#fff; border:1px solid var(--line); border-radius:var(--radius-xl); }
    .pad{ padding:18px; }
  
    /* HEADER seguindo o index.html (apenas garante tamanho) */
    .header .brand h1{
      font-size: var(--title-size) !important;
      font-weight: var(--title-weight) !important;
      color: var(--title-color) !important;
      margin: 0;
    }
  
    /* TÍTULOS (ESQ e DIR idênticos): */
    .card-title{
      margin:2px 0 14px 0;
      padding-left: var(--cell-pad-x);
      font-size: var(--title-size) !important;
      font-weight: var(--title-weight) !important;
      color: var(--title-color) !important;
    }
  
    /* LABELS (ESQ e DIR idênticos): */
    .form label,
    .filters label,
    label{
      margin-left: var(--cell-pad-x);
      font-size: var(--label-size) !important;
      font-weight: var(--label-weight) !important;
      color: var(--label-color) !important;
    }
    .req::after{ content:" *"; color:#ef4444; }
  
    .input{
      margin-left: var(--cell-pad-x);
      border-radius:12px;
    }
    .input::placeholder{ color:var(--muted-2); }
  
    /* TABELA – cabeçalho com MESMA tipografia dos labels: */
    .scroll{ margin-top:4px; overflow:auto; }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{
      font-size: var(--label-size) !important;
      font-weight: var(--label-weight) !important;
      color: var(--label-color) !important;
    }
    th, td{
      padding:11px var(--cell-pad-x);
      text-align:left; vertical-align:middle; border-bottom:1px solid var(--line);
    }
    tr:hover td{ background:#fbfcff; }
    th.sortable{ cursor:pointer; user-select:none; }
    th.sortable:hover{ text-decoration: underline dotted; }
  
    /* FILTROS – checkbox “Tipo” alinhado com checkbox da tabela */
    .filters .col{ display:flex; flex-direction:column; min-width:240px; }
    .filters .col > .input{ margin-left: var(--cell-pad-x); }
    #tiposBox{ margin-left: calc(var(--first-col-w) + var(--cell-pad-x)); }
  
    .filters-actions{ margin:10px 0 14px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
  
    .row{ display:flex; gap:10px; }
    .row.center{ align-items:center; }
    .row-actions{ display:flex; gap:10px; margin-top:12px; margin-left: var(--cell-pad-x); }
    #count{ color:var(--muted); padding:8px var(--cell-pad-x); }
  
    .grid-2{ display:grid; gap:18px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 980px){ .grid-2{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<!-- HEADER idêntico ao index.html (estrutura/classes) -->
<header class="header">
  <div class="container">
    <div class="brand">
      <img src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1>CETESB – Administração de Credenciais</h1>
    </div>
    <div class="actions" style="display:flex; gap:10px; align-items:center;">
      <a class="btn" href="consulta.html">Consulta</a>
      <button class="btn" id="btnChangePass">Trocar senha</button>
      <button class="btn danger" id="btnSair">Sair</button>
    </div>
  </div>
</header>

<main class="container" style="padding-top:18px; padding-bottom:18px;">
  <div class="grid-2">
    <!-- ESQUERDA -->
    <section class="card pad">
      <h2 class="card-title">Cadastro</h2>

      <form id="formCad" class="form" autocomplete="off">
        <div class="field">
          <label for="registro" class="req">Registro</label>
          <input id="registro" class="input" placeholder="000001" maxlength="6" pattern="[0-9]{6}" required>
        </div>

        <div class="field">
          <label for="nome" class="req">Nome</label>
          <input id="nome" class="input" required>
        </div>

        <div class="field">
          <label for="sigla" class="req">Unidade</label>
          <select id="sigla" class="input" required></select>
        </div>

        <div class="field">
          <label for="cred_cod" class="req">Tipo</label>
          <select id="cred_cod" class="input" required></select>
        </div>

        <div class="field">
          <label for="cred_num" class="req">Número</label>
          <input id="cred_num" class="input" maxlength="4" pattern="[0-9]{1,4}" required>
        </div>

        <div class="field">
          <label for="validade" class="req">Validade</label>
          <input id="validade" class="input" type="date" required>
        </div>

        <div class="field">
          <label for="status" class="req">Status</label>
          <select id="status" class="input" required>
            <option>Em andamento</option>
            <option>Ativo</option>
            <option>Inativo</option>
          </select>
        </div>

        <div class="field">
          <label for="doe">DOE (nº-ano)</label>
          <input id="doe" class="input" placeholder="12345-2025" pattern="^\\d{1,6}\\-\\d{4}$">
        </div>

        <div class="field">
          <label>Foto</label>
          <div class="row center" style="gap:12px;flex-wrap:wrap">
            <img id="preview" alt="Prévia da foto" width="120" height="120" style="border:1px solid var(--line);border-radius:12px;object-fit:cover; background:#f2f5fa; margin-left: var(--cell-pad-x);">
            <div class="row" style="gap:8px;flex-wrap:wrap">
              <input id="arquivoFoto" type="file" accept="image/*" style="display:none">
              <button type="button" class="btn" id="btnEscolherArquivo">Selecionar foto</button>
              <button type="button" class="btn danger" id="btnRemoverFoto">Remover foto</button>
            </div>
          </div>
        </div>

        <div class="row-actions">
          <button id="btnNovo" type="button" class="btn">Novo</button>
          <button id="btnExcluir" type="button" class="btn danger">Excluir</button>
          <button id="btnQR" type="button" class="btn">Gerar QR</button>
          <button id="btnSalvar" type="submit" class="btn primary">Salvar</button>
        </div>
      </form>
    </section>

    <!-- DIREITA -->
    <section class="card pad">
      <h2 class="card-title">Lista e filtros</h2>

      <div class="filters">
        <div class="row" style="gap:10px;flex-wrap:wrap;align-items:flex-end">
          <div class="col">
            <label for="f_nome">Nome</label>
            <input id="f_nome" class="input" placeholder="Ex.: MARIA">
          </div>
          <div class="col">
            <label for="f_reg">Matrícula</label>
            <input id="f_reg" class="input" placeholder="Ex.: 000123" maxlength="6">
          </div>
          <div class="col">
            <label for="f_numero">Número (credencial)</label>
            <input id="f_numero" class="input" placeholder="Ex.: 0042" maxlength="4">
          </div>
          <div class="col">
            <label for="f_status">Status</label>
            <select id="f_status" class="input">
              <option value="">Todos</option>
              <option>Ativo</option>
              <option>Em andamento</option>
              <option>Inativo</option>
            </select>
          </div>
          <div class="col">
            <label for="f_sigla">Unidade</label>
            <select id="f_sigla" class="input"></select>
          </div>

          <div class="col" style="flex:1 1 100%">
            <label for="tiposBox">Tipo</label>
            <div id="tiposBox" class="row" style="gap:10px;flex-wrap:wrap">
              <span style="color:var(--muted-2); margin-left: var(--cell-pad-x)">carregando…</span>
            </div>
          </div>
        </div>

        <div class="filters-actions">
          <button id="btnReload" class="btn">Recarregar</button>
          <button id="btnQrSelecionados" class="btn">QR em lote</button>
        </div>
      </div>

      <div class="scroll">
        <table id="tabela">
          <thead>
            <tr>
              <th style="width:var(--first-col-w)"><input id="chkAll" type="checkbox" title="Marcar todos"></th>
              <th style="width:var(--foto-col-w)">Foto</th>
              <th class="sortable" data-col="registro">Matrícula</th>
              <th class="sortable" data-col="nome">Nome</th>
              <th class="sortable" data-col="sigla">Unidade</th>
              <th class="sortable" data-col="cred_num">Número</th>
              <th class="sortable" data-col="cred_cod">Tipo</th>
              <th class="sortable" data-col="validade">Validade</th>
              <th class="sortable" data-col="status">Status</th>
              <th style="width:140px">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="count">0 registro(s)</div>
    </section>
  </div>
</main>

<footer class="footer">
  <div class="container"><span class="muted">Piloto – CETESB</span></div>
</footer>

<script type="module">
  /* util */
  const $=(s)=>document.querySelector(s);
  const fmt=(iso)=>iso?new Date(iso).toLocaleDateString('pt-BR'):'';
  const PH120="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%25' height='100%25' fill='%23eef2f7' rx='12' ry='12'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='12' fill='%2390a4b8'>sem foto</text></svg>";
  const PH40 ="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect width='100%25' height='100%25' fill='%23eef2f7' rx='8' ry='8'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='16' fill='%2390a4b8'>?</text></svg>";

  const norm=(s)=>String(s??'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();
  function displayStatus(rec){
    const raw = norm(rec.status);
    const hoje = new Date(new Date().toDateString());
    if (raw === 'ativo') return (rec.validade && new Date(rec.validade) >= hoje) ? 'Ativo' : 'Inativo';
    if (raw === 'em andamento') return 'Em andamento';
    return 'Inativo';
  }
  const statusChip=(label)=> label==='Ativo' ? '<span class="chip success">Ativo</span>' :
                         label==='Em andamento' ? '<span class="chip warn">Em andamento</span>' :
                         '<span class="chip danger">Inativo</span>';

  let sortCol='registro', sortAsc=true;

  /* navegação */
  $('#btnSair')?.addEventListener('click',()=>{localStorage.removeItem('sessaoUsuario');location.href='index.html';});
  $('#btnChangePass')?.addEventListener('click',()=>{location.href='change-password.html';});

  /* preview */
  $('#btnEscolherArquivo').addEventListener('click',()=>$('#arquivoFoto').click());
  $('#arquivoFoto').addEventListener('change',(ev)=>{ const f=ev.target.files?.[0]; $('#preview').src=f?URL.createObjectURL(f):PH120; });

  /* config + supabase */
  let cfg;
  try{
    const r=await fetch('config.json',{cache:'no-store'});
    if(!r.ok) throw new Error('Falha ao carregar config.json');
    cfg=await r.json();
  }catch(e){ console.error(e); alert('Falha ao carregar config.json'); throw e; }

  const supa = await import('https://esm.sh/@supabase/supabase-js@2');
  const supabase = supa.createClient(cfg.supabaseUrl,cfg.supabaseAnonKey);

  /* helpers foto */
  const UNITS_MAP=Object.create(null);
  const normalize=(p)=>String(p||'').replace(/^fotos\//i,'');
  const splitDir=(b)=>{const i=b.lastIndexOf('/');return i===-1?{dir:'',name:b}:{dir:b.slice(0,i),name:b.slice(i+1)};}
  async function objExists(bucket,full){const t=splitDir(full);const r=await supabase.storage.from(bucket).list(t.dir||'',{search:t.name,limit:1});if(r.error)return false;return (r.data||[]).some(x=>x.name===t.name);}
  async function getFotoUrlIfExists(path){const bucket=cfg.storageBucket||'fotos';if(!await objExists(bucket,path))return null;const s=await supabase.storage.from(bucket).createSignedUrl(path,3600);if(s?.data?.signedUrl)return s.data.signedUrl;const p=supabase.storage.from(bucket).getPublicUrl(path);return p?.data?.publicUrl||null;}
  async function getFotoUrlFlexible(reg,foto_path,{strict=false}={}){const list=[];if(foto_path){list.push(normalize(foto_path));if(!strict){list.push(reg+'.png',reg+'.jpg',reg+'.jpeg')}}else if(!strict){list.push(reg+'.png',reg+'.jpg',reg+'.jpeg')}for(const k of list){const u=await getFotoUrlIfExists(k);if(u)return u}return null;}
  async function removeOtherExtAfterUpload(reg,keepKey){const keep=normalize(keepKey);const bucket=cfg.storageBucket||'fotos';const all=[reg+'.png',reg+'.jpg',reg+'.jpeg'];const toRemove=all.filter(k=>k!==keep);try{await supabase.storage.from(bucket).remove(toRemove)}catch{}}
  async function deleteAllKnownPhotos(reg,currentKey){const bucket=cfg.storageBucket||'fotos';const keys=[reg+'.png',reg+'.jpg',reg+'.jpeg'];if(currentKey){const cur=normalize(currentKey);if(!keys.includes(cur))keys.push(cur)}try{await supabase.storage.from(bucket).remove(keys)}catch{}}
  async function uploadFotoSeHouver(reg){
    const file = $('#arquivoFoto').files?.[0];
    if (!file) return null;
  
    const ext = (file.name.split('.').pop() || 'png').toLowerCase();
    const key = `${reg}.${ext}`;
    const bucket = cfg.storageBucket || 'fotos';
    const contentType = file.type || (
      ext==='png' ? 'image/png' :
      (ext==='jpg'||ext==='jpeg') ? 'image/jpeg' : 'application/octet-stream'
    );
  
    // 0) logs úteis
    console.log('[uploadFotoSeHouver] bucket=', bucket, 'key=', key, 'file=', file?.name, 'ext=', ext);
  
    // 1) TENTAR SIGNED UPLOAD (opcional) — se você configurar a função Edge
    //    Para habilitar: em config.json inclua:
    //    { "edgeFunctionName": "NOME_DA_FUNCAO", "appSecret": "se-tiver-segredo" }
    const edgeName = (cfg.edgeFunctionName || '').trim();
    if (edgeName) {
      try {
        const resp = await fetch(`${cfg.supabaseUrl}/functions/v1/${edgeName}/sign-upload`, {
          method: 'POST',
          headers: {
            'content-type': 'application/json',
            ...(cfg.appSecret ? {'x-app-secret': cfg.appSecret} : {})
          },
          body: JSON.stringify({ registro: reg, ext })
        });
        const signed = await resp.json().catch(()=> ({}));
        console.log('[signed-upload] resp.ok=', resp.ok, 'payload=', signed);
  
        if (resp.ok && signed?.path && signed?.token) {
          // sobe com token assinado (ignora RLS de escrita)
          const up = await supabase.storage.from(bucket)
            .uploadToSignedUrl(signed.path, signed.token, file, { contentType });
          console.log('[uploadToSignedUrl] resp=', up);
          if (up?.error) throw up.error;
          // limpeza não crítica
          try { await removeOtherExtAfterUpload(reg, key); } catch(e) { console.warn('Remoção opcional falhou:', e); }
          return key;
        } else {
          console.warn('[signed-upload] indisponível; caindo para fluxo direto. Detalhe:', signed?.error || '(sem detalhe)');
        }
      } catch (e) {
        console.warn('[signed-upload] falhou; caindo para fluxo direto.', e);
      }
    } else {
      console.log('[signed-upload] desabilitado (edgeFunctionName não definido em config.json)');
    }
  
    // 2) FLUXO DIRETO (RLS do Storage precisa permitir INSERT/UPDATE no bucket)
    //    Primeiro tenta INSERT puro; se já existir, tenta UPSERT.
    const ins = await supabase.storage.from(bucket).upload(key, file, { upsert: false, contentType });
    console.log('[upload direct][INSERT] resp=', ins);
    if (ins.error) {
      const upd = await supabase.storage.from(bucket).upload(key, file, { upsert: true, contentType });
      console.log('[upload direct][UPSERT] resp=', upd);
      if (upd.error) {
        console.error('[upload direct] erro final:', upd.error);
        throw new Error(upd.error.message || 'Falha no upload da foto');
      }
    }
  
    // 3) Remover outras extensões (não bloqueia o fluxo)
    try { await removeOtherExtAfterUpload(reg, key); } catch(e) { console.warn('Remoção opcional falhou:', e); }
  
    return key;
  }

  /* combos */
  async function carregarCombos(){
    const [u,c]=await Promise.all([
      supabase.from('unidades').select('sigla,nome_da_unidade').order('sigla'),
      supabase.from('credenciais').select('cred_cod,descricao').order('cred_cod')
    ]);
    if(u.error){ console.error(u.error); alert('Erro ao carregar unidades'); }
    if(c.error){ console.error(c.error); alert('Erro ao carregar credenciais'); }

    const un=u.data||[], cr=c.data||[];
    $('#sigla').innerHTML=un.map(x=>{UNITS_MAP[x.sigla]=x.nome_da_unidade||'';return `<option value="${x.sigla}">${x.sigla} – ${x.nome_da_unidade||''}</option>`}).join('');
    $('#cred_cod').innerHTML=cr.map(x=>`<option value="${x.cred_cod}">${x.cred_cod} – ${x.descricao||''}</option>`).join('');
    $('#f_sigla').innerHTML=`<option value="">Todas</option>`+un.map(x=>`<option value="${x.sigla}">${x.sigla}</option>`).join('');
    const tipos=$('#tiposBox'); tipos.innerHTML = cr.length ? cr.map(x=>`<label style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" class="f_tipo" value="${x.cred_cod}"> ${x.cred_cod}</label>`).join('') : `<span style="color:var(--muted-2); margin-left: var(--cell-pad-x)">Nenhum tipo cadastrado</span>`;
  }
  const tiposSelecionados=()=>Array.from(document.querySelectorAll('.f_tipo:checked')).map(el=>el.value);

  /* ordenação cabeçalho */
  function bindSortHeaders(){
    document.querySelectorAll('th.sortable').forEach(th=>{
      th.onclick=()=>{const col=th.getAttribute('data-col');if(!col)return; if(sortCol===col) sortAsc=!sortAsc; else {sortCol=col;sortAsc=true;} carregarLista();};
    });
  }

  /* lista */
  async function carregarLista(){
    try{
      const nome=$('#f_nome').value.trim();
      const regPart=$('#f_reg').value.trim();
      const numPart=$('#f_numero').value.trim();
      const fSig=$('#f_sigla').value;
      const fTipos=tiposSelecionados();

      let query=supabase.from('empregados').select('registro,nome,sigla,cred_num,cred_cod,validade,status,foto_path');

      if(nome) query=query.ilike('nome',`%${nome}%`);
      if(fSig) query=query.eq('sigla',fSig);
      if(fTipos.length) query=query.in('cred_cod', fTipos.map(Number));

      if (sortCol !== 'status') query = query.order(sortCol,{ascending:sortAsc});
      query = query.order('registro',{ascending:true});

      const res=await query;
      if(res.error){ console.error(res.error); alert('Erro ao carregar lista'); return; }
      let data=res.data||[];

      const fs = ($('#f_status').value||'').trim();
      if (fs) data = data.filter(r => displayStatus(r) === fs);

      if(regPart) data=data.filter(x=>String(x.registro||'').includes(regPart));
      if(numPart) data=data.filter(x=>String(x.cred_num||'').includes(numPart));

      if (sortCol === 'status') {
        data.sort((a,b)=>{ const sa=displayStatus(a), sb=displayStatus(b); const cmp=sa.localeCompare(sb,'pt-BR'); return sortAsc?cmp:-cmp; });
      }

      const linhas=await Promise.all(data.map(async x=>{
        const url=await getFotoUrlFlexible(x.registro,x.foto_path,{strict:!x.foto_path});
        const avatar=url||PH40;
        const chip = statusChip(displayStatus(x));
        return `<tr data-reg="${x.registro}">
          <td><input type="checkbox" class="chkRow" value="${x.registro}"></td>
          <td><img src="${avatar}" width="40" height="40" style="border-radius:10px;object-fit:cover;border:1px solid var(--line);background:#f2f5fa" onerror="this.src='${PH40}'"></td>
          <td>${x.registro}</td>
          <td>${x.nome||''}</td>
          <td>${x.sigla||''}</td>
          <td>${x.cred_num||''}</td>
          <td>${x.cred_cod||''}</td>
          <td>${fmt(x.validade)}</td>
          <td>${chip}</td>
          <td><button class="btn sm" data-acao="editar">Editar</button> <a class="btn sm" target="_blank" href="public.html?reg=${x.registro}">Público</a></td>
        </tr>`;
      }));
      $('#tbody').innerHTML=linhas.join('')||'<tr><td colspan="10" style="color:var(--muted); padding:10px var(--cell-pad-x)">Nenhum registro</td></tr>';
      $('#count').textContent=String(data.length)+' registro(s)';
      $('#chkAll').checked=false;
      $('#chkAll').onchange=(ev)=>{document.querySelectorAll('.chkRow').forEach(ch=>ch.checked=ev.target.checked);};
    }catch(e){ console.error('Falha em carregarLista:', e); alert('Erro inesperado ao listar.'); }
  }

  /* editar */
  $('#tbody').addEventListener('click',async (ev)=>{
    const btn=ev.target.closest?.('[data-acao="editar"]'); const tr=ev.target.closest('tr');
    const reg=tr?.getAttribute('data-reg'); if(!tr||!btn) return;
    const res=await supabase.from('empregados').select('*').eq('registro',reg).maybeSingle();
    if(res.error){alert('Erro ao carregar registro');return;}
    const d=res.data||{};
    $('#registro').value=d.registro||'';$('#nome').value=d.nome||'';$('#sigla').value=d.sigla||'';
    $('#cred_cod').value=d.cred_cod||'';$('#cred_num').value=d.cred_num||'';$('#validade').value=d.validade?String(d.validade).slice(0,10):'';
    $('#status').value=d.status||'Em andamento';$('#doe').value=d.doe||'';
    const url=await getFotoUrlFlexible(d.registro,d.foto_path,{strict:!d.foto_path});
    $('#preview').src=url||PH120;$('#arquivoFoto').value='';
  });

  /* novo */
  $('#btnNovo').addEventListener('click',()=>{$('#formCad').reset();$('#preview').src=PH120;$('#arquivoFoto').value='';$('#status').value='Em andamento';$('#registro').focus();});

  /* remover foto */
  $('#btnRemoverFoto').addEventListener('click',async()=>{
    const reg=$('#registro').value.trim(); if(!/^\d{6}$/.test(reg)) return alert('Informe um registro válido (6 dígitos).');
    const cur=await supabase.from('empregados').select('foto_path').eq('registro',reg).maybeSingle();
    await deleteAllKnownPhotos(reg,cur.data?.foto_path||null);
    await supabase.from('empregados').update({foto_path:null}).eq('registro',reg);
    $('#arquivoFoto').value='';$('#preview').src=PH120;await carregarLista();
  });

  /* obter nome da unidade para gravar junto (evita NOT NULL) */
  async function nomeUnidade(sig){ if(UNITS_MAP[sig]!=null)return UNITS_MAP[sig]; const ru=await supabase.from('unidades').select('nome_da_unidade').eq('sigla',sig).maybeSingle(); const v=ru?.data?.nome_da_unidade||''; UNITS_MAP[sig]=v; return v; }

  /* salvar */
  $('#formCad').addEventListener('submit',async(ev)=>{
    ev.preventDefault();
    const reg=$('#registro').value.trim(); if(!/^\d{6}$/.test(reg)) return alert('Registro inválido (6 dígitos).');
    const sig=$('#sigla').value;
    const payload={registro:reg,nome:$('#nome').value.trim(),sigla:sig,nome_da_unidade:await nomeUnidade(sig),
      cred_cod:Number($('#cred_cod').value),cred_num:$('#cred_num').value.trim(),validade:$('#validade').value,
      status:$('#status').value,doe:$('#doe').value.trim()||null};
    try{
      const fotoKey=await uploadFotoSeHouver(reg); if(fotoKey) payload.foto_path=fotoKey;
      const resp=await supabase.from('empregados').upsert(payload,{onConflict:'registro'}); if(resp.error) throw new Error(resp.error.message||'Erro ao salvar');
      const url=await getFotoUrlFlexible(reg,fotoKey||null,{strict:!fotoKey});$('#preview').src=url||PH120;$('#arquivoFoto').value='';
      await carregarLista();alert('Registro salvo com sucesso.');
    }catch(err){console.error(err);alert('Falha ao salvar: '+(err?.message||String(err))); }
  });

  /* QR Code */
  function publicUrlFor(reg){const base=new URL('public.html',location.href);base.searchParams.set('reg',reg);return base.href;}
  async function gerarQrDataUrl(reg,size=512){const {default:QRCode}=await import('https://esm.sh/qrcode@1.5.3');return await QRCode.toDataURL(publicUrlFor(reg),{width:size,margin:2,errorCorrectionLevel:'M'});}
  function downloadDataUrl(u,fn){const a=document.createElement('a');a.href=u;a.download=fn;document.body.appendChild(a);a.click();a.remove();}
  $('#btnQR').addEventListener('click',async()=>{try{const reg=$('#registro').value.trim();if(!/^\d{6}$/.test(reg))return alert('Informe um registro válido (6 dígitos).');downloadDataUrl(await gerarQrDataUrl(reg,512),`QR_${reg}.png`);}catch(e){console.error(e);alert('Falha ao gerar QR.');}});
  $('#btnQrSelecionados').addEventListener('click',async()=>{const regs=Array.from(document.querySelectorAll('.chkRow:checked')).map(ch=>ch.value);if(!regs.length)return alert('Selecione ao menos um registro.');for(const r of regs){try{downloadDataUrl(await gerarQrDataUrl(r,512),`QR_${r}.png`);}catch(e){console.error('QR falhou para',r,e);}}});

  /* binds e carregamento */
  $('#btnReload').addEventListener('click',carregarLista);
  $('#f_sigla').addEventListener('change',carregarLista);
  $('#f_status').addEventListener('change',carregarLista);
  ['f_numero','f_reg','f_nome'].forEach(id=>$('#'+id).addEventListener('input',()=>{clearTimeout(window['_deb'+id]);window['_deb'+id]=setTimeout(carregarLista,250);} ));
  document.addEventListener('change',(e)=>{if(e.target?.classList?.contains('f_tipo'))carregarLista();});

  bindSortHeaders();
  await carregarCombos();
  await carregarLista();
</script>
</body>
</html>
