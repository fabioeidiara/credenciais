<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Admin – CETESB Credenciais</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="style.css?v=233" rel="stylesheet">
  <meta name="color-scheme" content="light">
</head>
<body>
<header class="header">
  <div class="container">
    <div class="brand">
      <img src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1>CETESB – Administração de Credenciais</h1>
    </div>
    <div class="actions">
      <a class="btn" href="consulta.html">Consulta</a>
      <button class="btn" id="btnChangePass">Trocar senha</button>
      <button class="btn danger" id="btnSair">Sair</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="grid grid-2">
    <!-- ESQUERDA: FORM (estruturas e classes preservadas) -->
    <section class="card pad">
      <h2 class="card-title">Cadastro</h2>

      <form class="form" id="formCad" autocomplete="off">
        <div class="field">
          <label for="registro" class="req">Registro (6 dígitos)</label>
          <input id="registro" class="input" placeholder="000001" maxlength="6" pattern="[0-9]{6}" required>
        </div>

        <div class="field">
          <label for="nome" class="req">Nome</label>
          <input id="nome" class="input" required>
        </div>

        <div class="field">
          <label for="sigla" class="req">Sigla da unidade</label>
          <select id="sigla" class="input" required></select>
        </div>

        <div class="field">
          <label for="cred_cod" class="req">Tipo de credencial</label>
          <select id="cred_cod" class="input" required></select>
        </div>

        <div class="field">
          <label for="cred_num">Nº da credencial (4 dígitos)</label>
          <input id="cred_num" class="input" maxlength="4" pattern="[0-9]{0,4}">
        </div>

        <div class="field">
          <label for="validade" class="req">Validade</label>
          <input id="validade" class="input" type="date" required>
        </div>

        <div class="field">
          <label for="status" class="req">Status</label>
          <select id="status" class="input" required>
            <option>Em andamento</option>
            <option>Ativo</option>
            <option>Inativo</option>
          </select>
        </div>

        <div class="field">
          <label for="doe">DOE (Nº/ano)</label>
          <input id="doe" class="input" placeholder="12345/2025" pattern="^\\d{1,6}\\/\\d{4}$">
          <small class="muted">Formato sugerido: 12345/2025</small>
        </div>

        <div class="field">
          <label>Foto</label>

          <div class="row" style="gap:12px;align-items:center;flex-wrap:wrap">
            <img id="preview" alt="Prévia da foto" width="120" height="120"
                 style="border-radius:8px;object-fit:cover;border:1px solid #ddd">

            <!-- Input de arquivo customizado (PT-BR) -->
            <div>
              <input id="arquivoFoto" type="file" accept="image/*" style="display:none">
              <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
                <button type="button" class="btn" id="btnEscolherArquivo">Selecionar arquivo</button>
                <span id="arquivoNome" class="muted">Nenhum arquivo selecionado</span>
              </div>

              <div class="row" style="gap:8px;margin-top:8px;flex-wrap:wrap">
                <button type="button" class="btn" id="btnUploadFoto">Enviar/Atualizar foto</button>
                <button type="button" class="btn danger" id="btnRemoverFoto">Remover foto</button>
              </div>
              <small class="muted">O nome do arquivo no Storage será &lt;registro&gt;.jpg/.png</small>
            </div>
          </div>
        </div>

        <!-- Linha de ações com classe própria para evitar “sanfona” -->
        <div class="row-actions">
          <button id="btnNovo" type="button" class="btn">Novo</button>
          <button id="btnExcluir" type="button" class="btn danger">Excluir</button>
          <button id="btnQR" type="button" class="btn">Gerar QR</button>
          <button id="btnSalvar" type="submit" class="btn primary">Salvar</button>
        </div>
      </form>
    </section>

    <!-- DIREITA: LISTA -->
    <section class="card pad">
      <h2 class="card-title">Lista e filtros</h2>

      <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
        <input id="q" class="input" style="flex:1 1 auto" placeholder="Buscar por nome, registro ou sigla">
        <select id="f_sigla" class="input" style="min-width:140px"></select>
        <select id="f_status" class="input" style="min-width:140px">
          <option value="">Todos</option>
          <option>Ativo</option>
          <option>Em andamento</option>
          <option>Inativo</option>
        </select>
        <button id="btnReload" class="btn">Recarregar</button>
      </div>

      <div class="scroll">
        <table class="table">
          <thead>
            <tr>
              <th style="width:56px">Foto</th>
              <th>Registro</th>
              <th>Nome</th>
              <th>Sigla</th>
              <th>Validade</th>
              <th>Status</th>
              <th style="width:120px">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="muted" id="count">0 registro(s)</div>
    </section>
  </div>
</main>

<footer class="footer"><div class="container">Piloto – CETESB</div></footer>

<script type="module">
  // -------------------------
  // Utilitários e constantes
  // -------------------------
  const $  = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const toast = (msg)=>{ console.log(msg); };

  // Placeholders embutidos (sem rede)
  const PH120 = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%25' height='100%25' fill='%23e5e7eb'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='12' fill='%2364748b'>sem foto</text></svg>";
  const PH40  = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect width='100%25' height='100%25' fill='%23e5e7eb'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='16' fill='%2364748b'>?</text></svg>";

  // Define placeholder inicial do preview sem depender de onerror
  $('#preview').src = PH120;

  // Sair / Trocar senha: registra IMEDIATAMENTE
  document.getElementById('btnSair')?.addEventListener('click', ()=>{
    localStorage.removeItem('sessaoUsuario');
    location.href = 'index.html';
  });
  document.getElementById('btnChangePass')?.addEventListener('click', ()=>{
    location.href = 'change-password.html';
  });

  // Botão "Selecionar arquivo" (PT-BR)
  $('#btnEscolherArquivo').addEventListener('click', ()=> $('#arquivoFoto').click());
  $('#arquivoFoto').addEventListener('change', (ev)=>{
    const file = ev.target.files?.[0];
    $('#arquivoNome').textContent = file ? file.name : 'Nenhum arquivo selecionado';
    if (file){
      const objUrl = URL.createObjectURL(file);
      $('#preview').src = objUrl; // prévia local imediata
    } else {
      $('#preview').src = PH120;
    }
  });

  // -------------------------
  // Carrega config.json (robusto)
  // -------------------------
  let cfg;
  try {
    const res = await fetch('config.json', { cache:'no-store' });
    if (!res.ok) throw new Error(`config.json HTTP ${res.status}`);
    const txt = await res.text();
    try { cfg = JSON.parse(txt); }
    catch(e){ console.error('config.json inválido:', txt); alert('config.json inválido'); throw e; }
  } catch (e) {
    console.error('Falha ao carregar config.json', e);
    alert('Falha ao carregar config.json');
    throw e; // listeners essenciais já estão ativos
  }

  // -------------------------
  // Supabase
  // -------------------------
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  const supabase = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);

  const normalizeFotoPath = (p)=> String(p||'').replace(/^fotos\//i,'');
  const buildFotoUrl = (foto_path)=>{
    if (!foto_path) return null;
    const bucket = (cfg.storageBucket || 'fotos');
    const path = normalizeFotoPath(foto_path);
    const { data } = supabase.storage.from(bucket).getPublicUrl(path);
    return data?.publicUrl || null;
  };
  const formatData = (iso)=> iso ? new Date(iso).toLocaleDateString('pt-BR') : '';

  // -------------------------
  // Combos
  // -------------------------
  async function carregarCombos(){
    const [u, c] = await Promise.all([
      supabase.from('unidades').select('sigla,nome_da_unidade').order('sigla'),
      supabase.from('credenciais').select('cred_cod,descricao').order('cred_cod')
    ]);
    $('#sigla').innerHTML = (u.data||[]).map(x=>`<option value="${x.sigla}">${x.sigla} – ${x.nome_da_unidade||''}</option>`).join('');
    $('#cred_cod').innerHTML = (c.data||[]).map(x=>`<option value="${x.cred_cod}">${x.cred_cod} – ${x.descricao||''}</option>`).join('');

    // filtros
    $('#f_sigla').innerHTML = `<option value="">Todas</option>` + (u.data||[]).map(x=>`<option value="${x.sigla}">${x.sigla}</option>`).join('');
  }

  // -------------------------
  // Lista
  // -------------------------
  async function carregarLista(){
    const q = $('#q').value.trim();
    const fs = $('#f_status').value;
    const fSig = $('#f_sigla').value;

    let query = supabase.from('empregados').select('registro,nome,sigla,validade,status,foto_path').order('registro');

    if (q){
      const isNum = /^\d+$/.test(q);
      if (isNum) query = query.or(`registro.eq.${q},cred_num.eq.${q}`);
      else query = query.ilike('nome', `%${q}%`);
    }
    if (fs)  query = query.eq('status', fs);
    if (fSig) query = query.eq('sigla', fSig);

    const { data, error } = await query;
    if (error) { console.error(error); alert('Erro ao carregar lista'); return; }

    const rows = (data||[]).map(x=>{
      const foto = buildFotoUrl(x.foto_path) || PH40;
      const statusChip =
        (x.status==='Ativo' && new Date(x.validade) >= new Date().setHours(0,0,0,0)) ? `<span class="chip success">Ativo</span>` :
        (x.status==='Em andamento') ? `<span class="chip warn">Em andamento</span>` :
        `<span class="chip danger">Inativo/Vencido</span>`;

      return `<tr data-reg="${x.registro}">
        <td><img src="${foto}" alt="foto" width="40" height="40" style="border-radius:6px;object-fit:cover;border:1px solid #ddd" onerror="this.src='${PH40}'"></td>
        <td>${x.registro}</td>
        <td>${x.nome||''}</td>
        <td>${x.sigla||''}</td>
        <td>${formatData(x.validade)}</td>
        <td>${statusChip}</td>
        <td>
          <button class="btn sm" data-acao="editar">Editar</button>
          <a class="btn sm" target="_blank" href="public.html?reg=${x.registro}">Público</a>
        </td>
      </tr>`;
    }).join('');

    $('#tbody').innerHTML = rows || `<tr><td colspan="7" class="muted">Nenhum registro</td></tr>`;
    $('#count').textContent = `${data?.length||0} registro(s)`;
  }

  // Click na tabela → carrega no form
  $('#tbody').addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('[data-acao="editar"]');
    if (!btn) return;
    const tr = ev.target.closest('tr');
    const reg = tr?.getAttribute('data-reg');
    if (!reg) return;

    const { data, error } = await supabase.from('empregados').select('*').eq('registro', reg).maybeSingle();
    if (error) { alert('Erro ao carregar registro'); return; }

    $('#registro').value  = data.registro || '';
    $('#nome').value      = data.nome || '';
    $('#sigla').value     = data.sigla || '';
    $('#cred_cod').value  = data.cred_cod || '';
    $('#cred_num').value  = data.cred_num || '';
    $('#validade').value  = data.validade ? String(data.validade).slice(0,10) : '';
    $('#status').value    = data.status || 'Em andamento';
    $('#doe').value       = data.doe || '';

    // atualiza prévia
    const url = buildFotoUrl(data.foto_path);
    $('#preview').src = url || PH120;
  });

  // Botões
  $('#btnReload').addEventListener('click', carregarLista);
  $('#btnNovo').addEventListener('click', ()=>{
    $('#formCad').reset();
    $('#arquivoNome').textContent = 'Nenhum arquivo selecionado';
    $('#preview').src = PH120;
  });

  $('#btnExcluir').addEventListener('click', async ()=>{
    const reg = $('#registro').value.trim();
    if (!/^\d{6}$/.test(reg)) return alert('Informe um registro válido (6 dígitos).');
    if (!confirm(`Excluir ${reg}?`)) return;

    const { error } = await supabase.from('empregados').delete().eq('registro', reg);
    if (error) { alert('Erro ao excluir'); return; }
    toast('Excluído');
    carregarLista();
  });

  $('#btnQR').addEventListener('click', ()=>{
    const reg = $('#registro').value.trim();
    if (!/^\d{6}$/.test(reg)) return alert('Informe um registro válido (6 dígitos).');
    const url = new URL(location.href);
    url.pathname = url.pathname.replace(/admin\.html$/,'public.html');
    url.search = `?reg=${reg}`;
    window.open(`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url.href)}`,'_blank');
  });

  $('#btnUploadFoto').addEventListener('click', async ()=>{
    const reg = $('#registro').value.trim();
    if (!/^\d{6}$/.test(reg)) return alert('Informe um registro válido (6 dígitos).');
    const file = $('#arquivoFoto').files?.[0];
    if (!file) return alert('Selecione um arquivo de imagem.');

    const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
    const key = `${reg}.${ext}`;
    const bucket = (cfg.storageBucket || 'fotos');

    const { error: upErr } = await supabase.storage.from(bucket).upload(key, file, { upsert:true, contentType:file.type });
    if (upErr) { console.error(upErr); return alert('Falha no upload'); }

    const { error: dbErr } = await supabase.from('empregados').update({ foto_path: key }).eq('registro', reg);
    if (dbErr) { console.error(dbErr); return alert('Falha ao gravar foto no banco'); }

    const url = buildFotoUrl(key);
    $('#preview').src = url || PH120;
    toast('Foto atualizada.');
  });

  $('#btnRemoverFoto').addEventListener('click', async ()=>{
    const reg = $('#registro').value.trim();
    if (!/^\d{6}$/.test(reg)) return alert('Informe um registro válido (6 dígitos).');

    const { data } = await supabase.from('empregados').select('foto_path').eq('registro', reg).maybeSingle();
    const key = normalizeFotoPath(data?.foto_path);
    const bucket = (cfg.storageBucket || 'fotos');

    if (key){
      await supabase.storage.from(bucket).remove([key]).catch(()=>{});
    }
    await supabase.from('empregados').update({ foto_path: null }).eq('registro', reg);

    $('#preview').src = PH120;
    $('#arquivoFoto').value = '';
    $('#arquivoNome').textContent = 'Nenhum arquivo selecionado';
    toast('Foto removida.');
  });

  $('#formCad').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const reg = $('#registro').value.trim();
    if (!/^\d{6}$/.test(reg)) return alert('Registro inválido.');

    const payload = {
      registro: reg,
      nome: $('#nome').value.trim(),
      sigla: $('#sigla').value,
      cred_cod: Number($('#cred_cod').value),
      cred_num: $('#cred_num').value.trim() || null,
      validade: $('#validade').value,
      status: $('#status').value,
      doe: $('#doe').value.trim() || null
    };

    const { error } = await supabase.from('empregados').upsert(payload, { onConflict:'registro' });
    if (error) { console.error(error); return alert('Erro ao salvar'); }

    toast('Salvo com sucesso.');
    carregarLista();
  });

  // Inicialização
  await carregarCombos();
  await carregarLista();
</script>
</body>
</html>
