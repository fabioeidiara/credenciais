<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Consulta – CETESB Credenciais</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="style.css" rel="stylesheet">
</head>
<body>
<header class="header">
  <div class="container">
    <div class="brand">
      <img src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1>CETESB – Consulta de Credenciais</h1>
    </div>
    <div class="actions">
      <a class="btn" href="admin.html">Cadastro</a>
      <a class="btn" href="change-password.html">Senha</a>
      <button id="btnSair" class="btn danger">Sair</button>
    </div>
  </div>
</header>

<main class="container">
  <section class="card pad">
    <h2 class="card-title">Consulta</h2>

    <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
      <input id="q" class="input" style="flex:1 1 auto" placeholder="Buscar por nome, registro...">
      <select id="f_sigla" class="select"><option value="">— Sigla —</option></select>
      <select id="f_status" class="select">
        <option value="">— Status —</option>
        <option value="Ativo">Ativo</option>
        <option value="Em andamento">Em andamento</option>
        <option value="Inativo">Inativo</option>
      </select>
      <button id="btnReload" class="btn">Recarregar</button>
    </div>

    <div class="table-wrap mt-12">
      <table>
        <thead>
          <tr>
            <th>Registro</th>
            <th>Nome</th>
            <th>Sigla</th>
            <th>Validade</th>
            <th>Status</th>
            <th class="right">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div id="count" class="small muted mt-16">0 registro(s)</div>
  </section>

  <div id="toast" class="toast hidden alert success"><div id="toastMsg">OK</div></div>
</main>

<script type="module">
  const $ = (s)=>document.querySelector(s);
  const toast = (t, kind='success')=>{
    const el = $('#toast'); const m = $('#toastMsg');
    el.className = 'toast alert '+(kind==='error'?'error':kind==='warn'?'warn':'success');
    m.textContent = t; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'), 1800);
  };

  const sess = JSON.parse(localStorage.getItem('sessaoUsuario')||'null');
  if(!sess){ location.href = 'index.html'; throw new Error('sem sessão'); }

  let cfg; {
    const res = await fetch('config.json', { cache:'no-store' });
    if(!res.ok) { alert('Falha ao carregar config.json'); throw new Error(); }
    cfg = await res.json();
  }
  const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
  const supabase = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);

  $('#btnSair').addEventListener('click', ()=>{
    localStorage.removeItem('sessaoUsuario');
    location.href = 'index.html';
  });

  (async ()=>{
    const { data } = await supabase.from('unidades').select('sigla').order('sigla');
    if(data){
      $('#f_sigla').innerHTML = '<option value="">— Sigla —</option>'+ data.map(u=>`<option value="${u.sigla}">${u.sigla}</option>`).join('');
    }
  })();

  const todayZero = ()=>{ const d = new Date(); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); };
  const isVigente = (iso)=>{ if(!iso) return false; const [y,m,d]=iso.split('-').map(Number); return new Date(y,m-1,d) >= todayZero(); };
  const statusDerivado = (row)=>{
    if (row.status==='Em andamento') return {label:'Em andamento', cls:'andamento'};
    if (row.status==='Ativo' && isVigente(row.validade)) return {label:'Ativo', cls:'ativo'};
    return {label:'Inativo', cls:'inativo'};
  };
  const fmtBR = (iso)=> !iso ? '—' : (()=>{const [y,m,d]=iso.split('-');return `${d}/${m}/${y}`})();

  async function carregar(){
    const q = ($('#q').value||'').trim().toLowerCase();
    const sigla = $('#f_sigla').value||'';
    const fStatus = $('#f_status').value||'';

    let query = supabase.from('empregados')
      .select('registro,nome,sigla,validade,status', { count:'exact' })
      .order('registro', { ascending:true });

    if (sigla) query = query.eq('sigla', sigla);
    if (q) query = query.or(`nome.ilike.%${q}%,registro.ilike.%${q}%`);

    const { data, error } = await query;
    if (error){ console.error(error); toast('Erro ao carregar','error'); return; }

    let rows = data||[];
    if (fStatus) rows = rows.filter(r=> statusDerivado(r).label === fStatus);

    $('#tbody').innerHTML = rows.map(r=>{
      const sd = statusDerivado(r);
      return `<tr>
        <td>${r.registro}</td>
        <td>${r.nome||'—'}</td>
        <td>${r.sigla||'—'}</td>
        <td>${fmtBR(r.validade)||'—'}</td>
        <td><span class="chip ${sd.cls}">${sd.label}</span></td>
        <td class="right table-actions">
          <a class="btn" target="_blank" rel="noopener" href="public.html?reg=${r.registro}">Abrir</a>
        </td>
      </tr>`;
    }).join('');

    $('#count').textContent = `${rows.length} registro(s)`;
  }

  $('#btnReload').addEventListener('click', carregar);
  $('#q').addEventListener('input', ()=>{ clearTimeout(window._t); window._t=setTimeout(carregar,350); });
  $('#f_sigla').addEventListener('change', carregar);
  $('#f_status').addEventListener('change', carregar);

  carregar();
</script>
</body>
</html>
