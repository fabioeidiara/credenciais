<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Consulta – CETESB Credenciais</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="style.css?v=233" rel="stylesheet">
</head>
<body>
<header class="header">
  <div class="container">
    <div class="brand">
      <img src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1>CETESB – Consulta de Credenciais</h1>
    </div>
    <div class="actions">
      <a class="btn" href="admin.html">Admin</a>
      <button class="btn danger" id="btnSair">Sair</button>
    </div>
  </div>
</header>

<main class="container">
  <section class="card pad">
    <h2 class="card-title">Consulta</h2>

    <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
      <input id="q" class="input" style="flex:1 1 auto" placeholder="Buscar por nome, registro ou sigla">
      <select id="f_sigla" class="input" style="min-width:140px"></select>
      <select id="f_status" class="input" style="min-width:140px">
        <option value="">Todos</option>
        <option>Ativo</option>
        <option>Em andamento</option>
        <option>Inativo</option>
      </select>
      <button id="btnReload" class="btn">Recarregar</button>
    </div>

    <div class="scroll">
      <table class="table">
        <thead>
          <tr>
            <th style="width:56px">Foto</th>
            <th>Registro</th>
            <th>Nome</th>
            <th>Sigla</th>
            <th>Validade</th>
            <th>Status</th>
            <th style="width:120px">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="muted" id="count">0 registro(s)</div>
  </section>
</main>

<footer class="footer"><div class="container">Piloto – CETESB</div></footer>

<script type="module">
  const $  = (s)=>document.querySelector(s);
  const formatData = (iso)=> iso ? new Date(iso).toLocaleDateString('pt-BR') : '';

  // Placeholders embutidos
  const PH40  = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect width='100%25' height='100%25' fill='%23e5e7eb'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='16' fill='%2364748b'>?</text></svg>";

  // Sair imediato
  document.getElementById('btnSair')?.addEventListener('click', ()=>{
    localStorage.removeItem('sessaoUsuario');
    location.href = 'index.html';
  });

  // Config robusta
  let cfg;
  try {
    const res = await fetch('config.json', { cache:'no-store' });
    if (!res.ok) throw new Error(`config.json HTTP ${res.status}`);
    const txt = await res.text();
    try { cfg = JSON.parse(txt); }
    catch(e){ console.error('config.json inválido:', txt); alert('config.json inválido'); throw e; }
  } catch (e) {
    console.error('Falha ao carregar config.json', e);
    alert('Falha ao carregar config.json');
    throw e;
  }

  // Supabase
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  const supabase = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);
  const normalizeFotoPath = (p)=> String(p||'').replace(/^fotos\//i,'');
  const buildFotoUrl = (foto_path)=>{
    if (!foto_path) return null;
    const bucket = (cfg.storageBucket || 'fotos');
    const path = normalizeFotoPath(foto_path);
    const { data } = supabase.storage.from(bucket).getPublicUrl(path);
    return data?.publicUrl || null;
  };

  // Combos
  async function carregarCombos(){
    const { data } = await supabase.from('unidades').select('sigla').order('sigla');
    $('#f_sigla').innerHTML = `<option value="">Todas</option>` + (data||[]).map(x=>`<option value="${x.sigla}">${x.sigla}</option>`).join('');
  }

  // Lista
  async function carregar(){
    const q = $('#q').value.trim();
    const fs = $('#f_status').value;
    const fSig = $('#f_sigla').value;

    let query = supabase.from('empregados').select('registro,nome,sigla,validade,status,foto_path').order('registro');

    if (q){
      const isNum = /^\d+$/.test(q);
      if (isNum) query = query.or(`registro.eq.${q},cred_num.eq.${q}`);
      else query = query.ilike('nome', `%${q}%`);
    }
    if (fs)  query = query.eq('status', fs);
    if (fSig) query = query.eq('sigla', fSig);

    const { data, error } = await query;
    if (error) { console.error(error); alert('Erro ao carregar'); return; }

    const rows = (data||[]).map(x=>{
      const foto = buildFotoUrl(x.foto_path) || PH40;
      const statusChip =
        (x.status==='Ativo' && new Date(x.validade) >= new Date().setHours(0,0,0,0)) ? `<span class="chip success">Ativo</span>` :
        (x.status==='Em andamento') ? `<span class="chip warn">Em andamento</span>` :
        `<span class="chip danger">Inativo/Vencido</span>`;

      return `<tr>
        <td><img src="${foto}" alt="foto" width="40" height="40" style="border-radius:6px;object-fit:cover;border:1px solid #ddd" onerror="this.src='${PH40}'"></td>
        <td>${x.registro}</td>
        <td>${x.nome||''}</td>
        <td>${x.sigla||''}</td>
        <td>${formatData(x.validade)}</td>
        <td>${statusChip}</td>
        <td>
          <a class="btn sm" target="_blank" href="public.html?reg=${x.registro}">Público</a>
        </td>
      </tr>`;
    }).join('');

    $('#tbody').innerHTML = rows || `<tr><td colspan="7" class="muted">Nenhum registro</td></tr>`;
    $('#count').textContent = `${data?.length||0} registro(s)`;
  }

  // Eventos
  document.getElementById('btnReload').addEventListener('click', carregar);
  document.getElementById('q').addEventListener('input', ()=>{ clearTimeout(window._t); window._t=setTimeout(carregar,250); });
  document.getElementById('f_sigla').addEventListener('change', carregar);
  document.getElementById('f_status').addEventListener('change', carregar);

  // Start
  await carregarCombos();
  await carregar();
</script>
</body>
</html>
