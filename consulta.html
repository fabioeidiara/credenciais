<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Consulta – CETESB Credenciais</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="style.css?v=253" rel="stylesheet">
  <meta name="color-scheme" content="light">
  <link rel="icon" href="data:,">
  <style>
    .label-like{ font-size:12px; color:#64748b; }
    .muted{ color:#6b7280 }
    .filters-row{ display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end }
    .filters-row .stack{ display:flex; flex-direction:column; gap:6px }
    .filters-row .grow{ flex:1 1 220px }
    .tags{ display:flex; gap:10px; flex-wrap:wrap; padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb; }
    .filters-actions{ width:100%; display:flex; justify-content:center; gap:12px; margin-top:6px }
    .filters-actions .btn{ width:auto; white-space:nowrap; min-width:max-content }
    .input::placeholder{ color:#a8b3c0; opacity:1 }
    th.sortable{ cursor:pointer; user-select:none }
    th.sortable .caret{ font-size:10px; margin-left:6px; color:#94a3b8; opacity:.8 }
  </style>
</head>
<body>
<header class="header">
  <div class="container">
    <div class="brand">
      <img src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1>CETESB – Consulta de Credenciais</h1>
    </div>
    <div class="actions">
      <a class="btn" href="admin.html">Cadastro</a>
      <a class="btn" href="index.html">Início</a>
    </div>
  </div>
</header>

<main class="container">
  <section class="card pad">
    <h2 class="card-title">Lista e filtros</h2>

    <div class="filters-row">
      <div class="stack grow">
        <label class="label-like" for="f_nome">Nome</label>
        <input id="f_nome" class="input" placeholder="Ex.: MARIA">
      </div>

      <div class="stack">
        <label class="label-like" for="f_reg">Matrícula</label>
        <input id="f_reg" class="input" placeholder="Ex.: 000123" maxlength="6">
      </div>

      <div class="stack">
        <label class="label-like" for="f_numero">Número (credencial)</label>
        <input id="f_numero" class="input" placeholder="Ex.: 0042" maxlength="4">
      </div>

      <div class="stack">
        <label class="label-like" for="f_status">Status</label>
        <select id="f_status" class="input">
          <option value="">Todos</option>
          <option>Ativo</option>
          <option>Em andamento</option>
          <option>Inativo</option>
        </select>
      </div>

      <div class="stack">
        <label class="label-like" for="f_sigla">Unidade</label>
        <select id="f_sigla" class="input"></select>
      </div>

      <div class="stack" style="flex:1 1 100%">
        <span class="label-like">Tipo</span>
        <div id="tiposBox" class="tags"><span class="muted">carregando…</span></div>
      </div>

      <div class="filters-actions">
        <button id="btnReload" class="btn">Recarregar</button>
      </div>
    </div>

    <div class="scroll">
      <table class="table" id="tabela">
        <thead>
          <tr>
            <th style="width:56px">Foto</th>
            <th class="sortable" data-col="registro">Matrícula <span class="caret">▾▴</span></th>
            <th class="sortable" data-col="nome">Nome <span class="caret">▾▴</span></th>
            <th class="sortable" data-col="sigla">Unidade <span class="caret">▾▴</span></th>
            <th class="sortable" data-col="cred_num">Número <span class="caret">▾▴</span></th>
            <th class="sortable" data-col="cred_cod">Tipo <span class="caret">▾▴</span></th>
            <th class="sortable" data-col="validade">Validade <span class="caret">▾▴</span></th>
            <th class="sortable" data-col="status">Status <span class="caret">▾▴</span></th>
            <th style="width:120px">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div id="count" class="label-like">0 registro(s)</div>
  </section>
</main>

<footer class="footer"><div class="container">Piloto – CETESB</div></footer>

<script type="module">
  const $  = (s)=>document.querySelector(s);
  const fmt = (iso)=> iso ? new Date(iso).toLocaleDateString('pt-BR') : '';

  const PH40  = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect width='100%25' height='100%25' fill='%23eef2f7' rx='8' ry='8'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='16' fill='%2390a4b8'>?</text></svg>";

  // config
  let cfg;
  try{
    const r = await fetch('config.json', { cache:'no-store' });
    if(!r.ok) throw new Error('config.json HTTP '+r.status);
    cfg = JSON.parse(await r.text());
  }catch(e){ console.error(e); alert('Falha ao carregar config.json'); throw e; }

  // Supabase
  const supa = await import('https://esm.sh/@supabase/supabase-js@2');
  const supabase = supa.createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);

  // fotos (consulta permite fallback sempre)
  const splitDir = (basepath)=>{ const i=basepath.lastIndexOf('/'); return i===-1?{dir:'',name:basepath}:{dir:basepath.slice(0,i),name:basepath.slice(i+1)}; };
  async function objectExists(bucket, fullpath){
    const t = splitDir(fullpath);
    const res = await supabase.storage.from(bucket).list(t.dir || '', { search:t.name, limit:1 });
    if(res.error) return false;
    return (res.data||[]).some(x=>x.name===t.name);
  }
  async function getFotoUrlIfExists(path){
    const bucket = cfg.storageBucket || 'fotos';
    const ok = await objectExists(bucket, path);
    if(!ok) return null;
    const s = await supabase.storage.from(bucket).createSignedUrl(path, 3600);
    if(s && !s.error && s.data && s.data.signedUrl) return s.data.signedUrl;
    const p = supabase.storage.from(bucket).getPublicUrl(path);
    if(p && p.data && p.data.publicUrl) return p.data.publicUrl;
    return null;
  }
  async function getFotoUrl(reg, foto_path){
    const list = [];
    if (foto_path) list.push(foto_path);
    list.push(reg+'.png', reg+'.jpg', reg+'.jpeg');
    for (const k of list){
      const url = await getFotoUrlIfExists(k);
      if(url) return url;
    }
    return null;
  }

  // Combos/Tipos
  async function carregarCombos(){
    const [u,c] = await Promise.all([
      supabase.from('unidades').select('sigla').order('sigla'),
      supabase.from('credenciais').select('cred_cod').order('cred_cod')
    ]);
    const un = u.data||[], cr = c.data||[];
    $('#f_sigla').innerHTML  = `<option value="">Todas</option>` + un.map(x=>`<option value="${x.sigla}">${x.sigla}</option>`).join('');
    const tipos = $('#tiposBox');
    if(cr.length){
      tipos.innerHTML = cr.map(x=>`
        <label class="label-like" style="display:inline-flex;align-items:center;gap:6px">
          <input type="checkbox" class="f_tipo" value="${x.cred_cod}"> ${x.cred_cod}
        </label>`).join('');
    }else{
      tipos.innerHTML = `<span class="muted">Nenhum tipo cadastrado</span>`;
    }
  }
  const tiposSelecionados = ()=> Array.from(document.querySelectorAll('.f_tipo:checked')).map(el=>el.value);

  // Ordenação
  let sortCol = 'registro';
  let sortAsc = true;
  function bindSortHeaders(){
    document.querySelectorAll('th.sortable').forEach(th=>{
      th.addEventListener('click', ()=>{
        const col = th.getAttribute('data-col');
        if(!col) return;
        if (sortCol === col) sortAsc = !sortAsc; else { sortCol = col; sortAsc = true; }
        carregarLista();
      });
    });
  }

  // Lista
  async function carregarLista(){
    const nome = $('#f_nome').value.trim();
    const reg  = $('#f_reg').value.trim();
    const fNum = $('#f_numero').value.trim();
    const fs   = $('#f_status').value;
    const fSig = $('#f_sigla').value;
    const fTipos = tiposSelecionados();

    let query = supabase.from('empregados').select('registro,nome,sigla,cred_num,cred_cod,validade,status,foto_path');

    if(nome) query = query.ilike('nome', `%${nome}%`);
    if(reg)  query = query.eq('registro', reg);
    if(fNum) query = query.eq('cred_num', fNum);
    if(fs)   query = query.eq('status', fs);
    if(fSig) query = query.eq('sigla', fSig);
    if(fTipos.length) query = query.in('cred_cod', fTipos.map(Number));

    query = query.order(sortCol, { ascending: sortAsc }).order('registro', { ascending:true });

    const res = await query;
    if(res.error){ console.error(res.error); alert('Erro ao carregar lista'); return; }
    const data = res.data || [];

    const linhas = await Promise.all(data.map(async (x)=>{
      const url = await getFotoUrl(x.registro, x.foto_path);
      const avatar = url || PH40;
      const ok = (x.status==='Ativo' && x.validade && new Date(x.validade) >= new Date(new Date().toDateString()));
      const chip = ok ? '<span class="chip success">Ativo</span>' :
                (x.status==='Em andamento' ? '<span class="chip warn">Em andamento</span>' :
                                              '<span class="chip danger">Inativo</span>');
      return `<tr>
        <td><img src="${avatar}" alt="foto" width="40" height="40" style="border-radius:6px;object-fit:cover;border:1px solid #ddd" onerror="this.src='${PH40}'"></td>
        <td>${x.registro}</td>
        <td>${x.nome||''}</td>
        <td>${x.sigla||''}</td>
        <td>${x.cred_num||''}</td>
        <td>${x.cred_cod||''}</td>
        <td>${fmt(x.validade)}</td>
        <td>${chip}</td>
        <td><a class="btn sm" target="_blank" href="public.html?reg=${x.registro}">Público</a></td>
      </tr>`;
    }));

    $('#tbody').innerHTML = linhas.join('') || '<tr><td colspan="9" class="muted">Nenhum registro</td></tr>';
    $('#count').textContent = String(data.length)+' registro(s)';
  }

  // eventos de filtros
  $('#btnReload').addEventListener('click', carregarLista);
  $('#f_sigla').addEventListener('change', carregarLista);
  $('#f_status').addEventListener('change', carregarLista);
  $('#f_numero').addEventListener('input', ()=>{ clearTimeout(window._d1); window._d1=setTimeout(carregarLista,250); });
  $('#f_reg').addEventListener('input',   ()=>{ clearTimeout(window._d2); window._d2=setTimeout(carregarLista,250); });
  $('#f_nome').addEventListener('input',  ()=>{ clearTimeout(window._d3); window._d3=setTimeout(carregarLista,250); });
  $('#tiposBox').addEventListener('change', carregarLista);

  // init
  bindSortHeaders();
  await carregarCombos();
  await carregarLista();
</script>
</body>
</html>
