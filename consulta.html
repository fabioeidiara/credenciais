<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Consulta – CETESB Credenciais</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="style.css" rel="stylesheet">
</head>
<body>

<header class="header">
  <div class="container">
    <div class="brand">
      <img src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1>CETESB – Consulta de Credenciais</h1>
    </div>
    <div class="actions">
      <a class="btn" href="admin.html">Admin</a>
      <button id="btnSair" class="btn danger">Sair</button>
    </div>
  </div>
</header>

<main class="container">
  <section class="card pad">
    <h2 class="card-title">Consulta</h2>

    <div class="toolbar mb-12">
      <input id="q" class="input grow" placeholder="Buscar por nome, registro...">
      <select id="f_sigla" class="select">
        <option value="">— Sigla —</option>
      </select>
      <select id="f_status" class="select">
        <option value="">— Status —</option>
        <option value="Ativo">Ativo</option>
        <option value="Em andamento">Em andamento</option>
        <option value="Inativo">Inativo</option>
      </select>
      <button id="btnReload" class="btn">Recarregar</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Registro</th>
            <th>Nome</th>
            <th>Sigla</th>
            <th>Validade</th>
            <th>Status</th>
            <th class="right">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div id="count" class="small muted mt-8">0 registro(s)</div>
  </section>

  <div id="toast" class="toast hidden alert success"><div id="toastMsg">OK</div></div>
</main>

<script type="module">
  const $ = (s)=>document.querySelector(s);
  const toast = (t, kind='success')=>{
    const el = $('#toast'); const m = $('#toastMsg');
    el.className = 'toast alert '+(kind==='error'?'error':kind==='warn'?'warn':'success');
    m.textContent = t; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'), 2000);
  };

  // Config + Supabase
  let cfg; {
    const res = await fetch('config.json', { cache:'no-store' });
    if(!res.ok) { alert('Falha ao carregar config.json'); throw new Error(); }
    cfg = await res.json();
  }
  const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
  const supabase = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);

  // Auth
  const { data: { user } } = await supabase.auth.getUser();
  if(!user){ location.href = cfg.loginPage || 'index.html'; throw new Error('sem login'); }

  // Unidades para filtro
  (async ()=>{
    const { data } = await supabase.from('unidades').select('sigla').order('sigla');
    if(data){
      const f = $('#f_sigla');
      f.innerHTML = '<option value="">— Sigla —</option>'+ data.map(u=>`<option value="${u.sigla}">${u.sigla}</option>`).join('');
    }
  })();

  // Helpers de status
  const todayZero = ()=>{ const d = new Date(); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); };
  const isVigente = (validadeISO)=>{
    if(!validadeISO) return false;
    const [y,m,d] = validadeISO.split('-').map(Number);
    const V = new Date(y, m-1, d);
    return V >= todayZero();
  };
  const statusDerivado = (row)=>{
    if (row.status === 'Em andamento') return {label:'Em andamento', cls:'andamento'};
    if (row.status === 'Ativo' && isVigente(row.validade)) return {label:'Ativo', cls:'ativo'};
    return {label:'Inativo', cls:'inativo'};
  };
  const fmtDataISOtoBR = (iso)=> !iso ? '—' : (()=>{ const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}` })();

  // Listagem
  async function carregar(){
    const q = ($('#q').value||'').trim().toLowerCase();
    const sigla = $('#f_sigla').value||'';
    const fStatus = $('#f_status').value||'';

    let query = supabase.from('empregados')
      .select('registro,nome,sigla,validade,status', { count:'exact' })
      .order('registro', { ascending: true });

    if (sigla) query = query.eq('sigla', sigla);
    if (q) query = query.or(`nome.ilike.%${q}%,registro.ilike.%${q}%`);

    const { data, error } = await query;
    if (error){ console.error(error); toast('Erro ao carregar','error'); return; }

    let rows = data||[];
    if (fStatus) rows = rows.filter(r=> statusDerivado(r).label === fStatus);

    render(rows);
    $('#count').textContent = `${rows.length} registro(s)`;
  }

  function render(rows){
    $('#tbody').innerHTML = rows.map(r=>{
      const sd = statusDerivado(r);
      return `
        <tr>
          <td>${r.registro}</td>
          <td>${r.nome||'—'}</td>
          <td>${r.sigla||'—'}</td>
          <td>${fmtDataISOtoBR(r.validade)||'—'}</td>
          <td><span class="chip ${sd.cls}">${sd.label}</span></td>
          <td class="right table-actions">
            <a class="btn" target="_blank" rel="noopener" href="public.html?reg=${r.registro}">Abrir</a>
          </td>
        </tr>
      `;
    }).join('');
  }

  // Eventos
  $('#btnReload').addEventListener('click', carregar);
  $('#q').addEventListener('input', ()=>{ clearTimeout(window._t); window._t=setTimeout(carregar,350); });
  $('#f_sigla').addEventListener('change', carregar);
  $('#f_status').addEventListener('change', carregar);

  // Inicial
  carregar();

  // Sair
  $('#btnSair').addEventListener('click', async ()=>{
    await supabase.auth.signOut(); location.href = cfg.loginPage || 'index.html';
  });
</script>

</body>
</html>
