<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>CETESB – Consulta de Credenciais</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="style.css" rel="stylesheet">
  <meta name="color-scheme" content="light">
  <link rel="icon" href="data:,">
    <style>
    :root{
      --title-size: 16px;
      --title-weight: 700;
      --title-color: #3f4b5a;
  
      --label-size: 13px;
      --label-weight: 600;
      --label-color: #6b7787;   /* cinza MAIS CLARO */
  
      --cell-pad-x: 14px;
      --first-col-w: 56px;      /* alinha com coluna Foto */
      --radius-xl: 16px;
  
      --line: #e5e9f1;
      --muted: #64748b;
      --muted-2: #94a3b8;
    }
  
    .container{ max-width:1200px; margin:0 auto; padding:0 16px; }
    .card{ background:#fff; border:1px solid var(--line); border-radius:var(--radius-xl); }
    .pad{ padding:18px; }
  
    /* HEADER no mesmo padrão do index/admin */
    .header .brand h1{
      font-size: var(--title-size) !important;
      font-weight: var(--title-weight) !important;
      color: var(--title-color) !important;
      margin: 0;
    }
  
    /* TÍTULO da seção, igual ao admin (e ao 1º painel) */
    .card-title{
      margin:2px 0 14px 0;
      padding-left: var(--cell-pad-x);
      font-size: var(--title-size) !important;
      font-weight: var(--title-weight) !important;
      color: var(--title-color) !important;
    }
  
    /* LABELS iguais ao admin esquerdo */
    .filters label,
    label{
      margin-left: var(--cell-pad-x);
      font-size: var(--label-size) !important;
      font-weight: var(--label-weight) !important;
      color: var(--label-color) !important;
    }
  
    .input{
      margin-left: var(--cell-pad-x);
      border-radius:12px;
    }
    .input::placeholder{ color:var(--muted-2); }
  
    /* TABELA com cabeçalho idêntico aos labels (menor e cinza claro) */
    .scroll{ margin-top:4px; overflow:auto; }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{
      font-size: var(--label-size) !important;
      font-weight: var(--label-weight) !important;
      color: var(--label-color) !important;
    }
    th, td{
      padding:11px var(--cell-pad-x);
      text-align:left; vertical-align:middle; border-bottom:1px solid var(--line);
    }
    tr:hover td{ background:#fbfcff; }
    th.sortable{ cursor:pointer; user-select:none; }
    th.sortable:hover{ text-decoration: underline dotted; }
  
    /* “Tipo” alinhado com a coluna Foto */
    .filters .col{ display:flex; flex-direction:column; min-width:240px; }
    .filters .col > .input{ margin-left: var(--cell-pad-x); }
    #tiposBox{ margin-left: calc(var(--first-col-w) + var(--cell-pad-x)); }
  
    .filters-actions{ margin:10px 0 14px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    #count{ color:var(--muted); padding:8px var(--cell-pad-x); }
  </style>
</head>
<body>

<header class="header">
  <div class="container">
    <div class="brand">
      <img src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1>CETESB – Consulta de Credenciais</h1>
    </div>
    <div class="actions" style="display:flex; gap:10px; align-items:center;">
      <a class="btn" href="admin.html">Cadastro</a>
      <a class="btn" href="index.html">Início</a>
    </div>
  </div>
</header>

<main class="container" style="padding-top:18px; padding-bottom:18px;">
  <section class="card pad">
    <h2 class="card-title">Lista e filtros</h2>

    <div class="filters">
      <div class="row" style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
        <div class="col">
          <label for="f_nome">Nome</label>
          <input id="f_nome" class="input" placeholder="Ex.: MARIA">
        </div>
        <div class="col">
          <label for="f_reg">Matrícula</label>
          <input id="f_reg" class="input" placeholder="Ex.: 000123" maxlength="6">
        </div>
        <div class="col">
          <label for="f_numero">Número (credencial)</label>
          <input id="f_numero" class="input" placeholder="Ex.: 0042" maxlength="4">
        </div>
        <div class="col">
          <label for="f_status">Status</label>
          <select id="f_status" class="input">
            <option value="">Todos</option>
            <option>Ativo</option>
            <option>Em andamento</option>
            <option>Inativo</option>
          </select>
        </div>
        <div class="col">
          <label for="f_sigla">Unidade</label>
          <select id="f_sigla" class="input"></select>
        </div>

        <div class="col" style="flex:1 1 100%">
          <label for="tiposBox">Tipo</label>
          <div id="tiposBox" class="row" style="display:flex;gap:10px;flex-wrap:wrap">
            <span style="color:var(--muted-2); margin-left: var(--cell-pad-x)">carregando…</span>
          </div>
        </div>
      </div>

      <div class="filters-actions">
        <button id="btnReload" class="btn">Recarregar</button>
      </div>
    </div>

    <div class="scroll">
      <table id="tabela">
        <thead>
          <tr>
            <th style="width:var(--first-col-w)">Foto</th>
            <th class="sortable" data-col="registro">Matrícula</th>
            <th class="sortable" data-col="nome">Nome</th>
            <th class="sortable" data-col="sigla">Unidade</th>
            <th class="sortable" data-col="cred_num">Número</th>
            <th class="sortable" data-col="cred_cod">Tipo</th>
            <th class="sortable" data-col="validade">Validade</th>
            <th class="sortable" data-col="status">Status</th>
            <th style="width:120px">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div id="count">0 registro(s)</div>
  </section>
</main>

<footer class="footer">
  <div class="container"><span class="muted">Piloto – CETESB</span></div>
</footer>

<script type="module">
  const $=(s)=>document.querySelector(s);
  const fmt=(iso)=>iso?new Date(iso).toLocaleDateString('pt-BR'):'';
  const PH40 ="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect width='100%25' height='100%25' fill='%23eef2f7' rx='8' ry='8'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='16' fill='%2390a4b8'>?</text></svg>";

  const norm=(s)=>String(s??'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();
  function displayStatus(rec){
    const raw = norm(rec.status);
    const hoje = new Date(new Date().toDateString());
    if (raw === 'ativo') return (rec.validade && new Date(rec.validade) >= hoje) ? 'Ativo' : 'Inativo';
    if (raw === 'em andamento') return 'Em andamento';
    return 'Inativo';
  }
  const statusChip=(label)=> label==='Ativo' ? '<span class="chip success">Ativo</span>' :
                         label==='Em andamento' ? '<span class="chip warn">Em andamento</span>' :
                         '<span class="chip danger">Inativo</span>';

  let sortCol='registro', sortAsc=true;

  /* config + supabase */
  let cfg;{
    const r=await fetch('config.json',{cache:'no-store'});
    if(!r.ok){ alert('Falha ao carregar config.json'); throw new Error('config.json'); }
    cfg=await r.json();
  }
  const supa=await import('https://esm.sh/@supabase/supabase-js@2');
  const supabase=supa.createClient(cfg.supabaseUrl,cfg.supabaseAnonKey);

  /* storage helpers */
  const splitDir=(b)=>{const i=b.lastIndexOf('/');return i===-1?{dir:'',name:b}:{dir:b.slice(0,i),name:b.slice(i+1)};}
  async function objExists(bucket,full){const t=splitDir(full);const r=await supabase.storage.from(bucket).list(t.dir||'',{search:t.name,limit:1});if(r.error)return false;return (r.data||[]).some(x=>x.name===t.name);}
  async function getFotoUrlIfExists(path){const bucket=cfg.storageBucket||'fotos';if(!await objExists(bucket,path))return null;const s=await supabase.storage.from(bucket).createSignedUrl(path,3600);if(s?.data?.signedUrl)return s.data.signedUrl;const p=supabase.storage.from(bucket).getPublicUrl(path);return p?.data?.publicUrl||null;}
  async function getFotoUrlFlexible(reg,foto_path,{strict=false}={}){const list=[];const normalize=(p)=>String(p||'').replace(/^fotos\//i,'');if(foto_path){list.push(normalize(foto_path));if(!strict){list.push(reg+'.png',reg+'.jpg',reg+'.jpeg')}}else if(!strict){list.push(reg+'.png',reg+'.jpg',reg+'.jpeg')}for(const k of list){const u=await getFotoUrlIfExists(k);if(u)return u}return null;}

  async function carregarCombos(){
    const [u,c]=await Promise.all([
      supabase.from('unidades').select('sigla').order('sigla'),
      supabase.from('credenciais').select('cred_cod').order('cred_cod')
    ]);
    if(u.error) console.error(u.error);
    if(c.error) console.error(c.error);
    const un=u.data||[], cr=c.data||[];
    $('#f_sigla').innerHTML=`<option value="">Todas</option>`+un.map(x=>`<option value="${x.sigla}">${x.sigla}</option>`).join('');
    const tipos=$('#tiposBox'); tipos.innerHTML = cr.length
      ? cr.map(x=>`<label style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" class="f_tipo" value="${x.cred_cod}"> ${x.cred_cod}</label>`).join('')
      : `<span style="color:var(--muted-2); margin-left: var(--cell-pad-x)">Nenhum tipo cadastrado</span>`;
  }
  const tiposSelecionados=()=>Array.from(document.querySelectorAll('.f_tipo:checked')).map(el=>el.value);

  function bindSortHeaders(){
    document.querySelectorAll('th.sortable').forEach(th=>{
      th.onclick=()=>{const col=th.getAttribute('data-col'); if(!col)return;
        if (sortCol===col) sortAsc=!sortAsc; else { sortCol=col; sortAsc=true; }
        carregarLista();
      };
    });
  }

  async function carregarLista(){
    const nome=$('#f_nome').value.trim();
    const regPart=$('#f_reg').value.trim();
    const numPart=$('#f_numero').value.trim();
    const fSig=$('#f_sigla').value;
    const fTipos=tiposSelecionados();

    let query=supabase.from('empregados').select('registro,nome,sigla,cred_num,cred_cod,validade,status,foto_path');
    if(nome) query=query.ilike('nome',`%${nome}%`);
    if(fSig) query=query.eq('sigla',fSig);
    if(fTipos.length) query=query.in('cred_cod',fTipos.map(Number));

    if (sortCol !== 'status') query = query.order(sortCol,{ascending:sortAsc});
    query = query.order('registro',{ascending:true});

    const res=await query;
    if(res.error){ console.error(res.error); alert('Erro ao carregar lista'); return; }
    let data=res.data||[];

    const fs = ($('#f_status').value||'').trim();
    if (fs) data = data.filter(r => displayStatus(r) === fs);

    if (regPart) data = data.filter(x => String(x.registro||'').includes(regPart));
    if (numPart) data = data.filter(x => String(x.cred_num||'').includes(numPart));

    if (sortCol === 'status') {
      data.sort((a,b)=>{ const sa=displayStatus(a), sb=displayStatus(b); const cmp=sa.localeCompare(sb,'pt-BR'); return sortAsc?cmp:-cmp; });
    }

    const linhas=await Promise.all(data.map(async x=>{
      const url=await getFotoUrlFlexible(x.registro,x.foto_path,{strict:!x.foto_path});
      const avatar=url||PH40;
      const chip=statusChip(displayStatus(x));
      return `<tr>
        <td><img src="${avatar}" width="40" height="40" style="border-radius:10px;object-fit:cover;border:1px solid var(--line);background:#f2f5fa" onerror="this.src='${PH40}'"></td>
        <td>${x.registro}</td>
        <td>${x.nome||''}</td>
        <td>${x.sigla||''}</td>
        <td>${x.cred_num||''}</td>
        <td>${x.cred_cod||''}</td>
        <td>${fmt(x.validade)}</td>
        <td>${chip}</td>
        <td><a class="btn sm" target="_blank" href="public.html?reg=${x.registro}">Público</a></td>
      </tr>`;
    }));
    $('#tbody').innerHTML = linhas.join('') || '<tr><td colspan="9" style="color:var(--muted); padding:10px var(--cell-pad-x)">Nenhum registro</td></tr>';
    $('#count').textContent = String(data.length)+' registro(s)';
  }

  $('#btnReload')?.addEventListener('click', carregarLista);
  $('#f_sigla').addEventListener('change', carregarLista);
  $('#f_status').addEventListener('change', carregarLista);
  ['f_numero','f_reg','f_nome'].forEach(id=>{
    $('#'+id).addEventListener('input', ()=>{
      clearTimeout(window['_deb'+id]);
      window['_deb'+id]=setTimeout(carregarLista,250);
    });
  });
  document.addEventListener('change',(e)=>{ if (e.target?.classList?.contains('f_tipo')) carregarLista(); });

  bindSortHeaders();
  await carregarCombos();
  await carregarLista();
</script>
</body>
</html>
