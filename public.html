<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Credencial do Agente – CETESB</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- caminhos RELATIVOS para GitHub Pages -->
  <link href="style.css" rel="stylesheet">
  <meta name="color-scheme" content="light">
</head>
<body>

<header class="header">
  <div class="container">
    <div class="brand">
      <img src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1>CETESB – Credencial do Agente</h1>
    </div>
    <div class="actions">
      <a class="btn ghost" href="index.html">Área restrita</a>
    </div>
  </div>
</header>

<main class="container">
  <div id="card" class="card pad hidden">
    <div class="qr-card">
      <img id="foto" class="avatar" src="" alt="Foto do agente">
      <div>
        <h2 id="nome">—</h2>
        <p class="muted" id="desc">—</p>
        <div class="row mt-8">
          <span id="statusChip" class="chip">Status</span>
          <span id="validadeChip" class="chip">Validade</span>
        </div>

        <div class="row mt-12">
          <span class="badge">Dados essenciais</span>
        </div>
        <div class="row">
          <div class="label">Nº da credencial:</div><div id="crednum">—</div>
        </div>
        <div class="row">
          <div class="label">Registro:</div><div id="registro">—</div>
        </div>
        <div class="row">
          <div class="label">Cargo:</div><div id="cargo">—</div>
        </div>
        <div class="row">
          <div class="label">Unidade:</div><div id="unidade">—</div>
        </div>
      </div>
    </div>
  </div>

  <div id="loading" class="alert mt-16">
    <div><strong>Carregando…</strong> Aguarde um instante.</div>
  </div>

  <div id="notfound" class="alert error mt-16 hidden">
    <div>
      <strong>Registro não encontrado ou credencial inativa.</strong>
      <div class="small">Verifique o número ou entre em contato com a CETESB.</div>
    </div>
  </div>

  <p class="footer">Confirme o domínio: <strong>*.github.io</strong> (piloto) ou <strong>*.cetesb.sp.gov.br</strong> (produção).</p>
</main>

<script type="module">
  const $ = (s)=>document.querySelector(s);
  const log = (t)=>{ $('#loading').innerHTML = `<div><strong>${t}</strong></div>`; console.log(t); };

  try {
    log('OK 1: script carregado');

    // 1) config.json (caminho RELATIVO!)
    let cfg;
    try{
      const url = 'config.json?v=3';
      log('OK 2: tentando fetch '+url);
      const res = await fetch(url, {cache:'no-store'});
      log('OK 3: fetch retornou HTTP '+res.status);
      if(!res.ok) throw new Error('HTTP '+res.status);
      cfg = await res.json();
      log('OK 4: config.json parseado');
    } catch(e) {
      log('ERRO A: falha ao carregar config.json — '+(e?.message||e));
      throw e;
    }

    // 2) importar SDK Supabase com fallback
    let createClient;
    try{
      log('OK 5: import esm.sh');
      ({ createClient } = await import('https://esm.sh/@supabase/supabase-js@2?edge'));
      log('OK 6: esm.sh ok');
    } catch(e1){
      log('WARN: esm.sh falhou, tentando jsdelivr… '+(e1?.message||e1));
      try{
        ({ createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'));
        log('OK 6b: jsdelivr ok');
      } catch(e2){
        log('ERRO B: não foi possível importar o SDK Supabase — '+(e2?.message||e2));
        throw e2;
      }
    }

    // 3) validar ?reg=
    const reg = (new URLSearchParams(location.search).get('reg')||'').trim();
    log('OK 7: reg="'+reg+'"');
    if(!/^\d{6}$/.test(reg)){ log('ERRO C: parâmetro reg inválido'); throw new Error('reg inválido'); }

    // 4) cliente Supabase
    log('OK 8: criando cliente supabase');
    const supabase = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);

    // 5) consultar empregado (SEM JOIN)
    log('OK 9: consultando empregados...');
    const empResp = await supabase.from('empregados')
      .select('registro,cred_num,validade,status,nome,cargo,sigla,nome_da_unidade,cred_cod,foto_path')
      .eq('registro', reg).maybeSingle();
    if(empResp.error){ log('ERRO D: query empregados — '+empResp.error.message); throw empResp.error; }
    if(!empResp.data){ log('ERRO E: registro não encontrado'); $('#loading').classList.add('hidden'); $('#notfound').classList.remove('hidden'); return; }
    log('OK 10: empregado encontrado');

    // 6) buscar descrição da credencial
    let descricao = '—';
    if (empResp.data.cred_cod != null){
      log('OK 11: buscando descricao da credencial...');
      const cResp = await supabase.from('credenciais').select('descricao').eq('cred_cod', empResp.data.cred_cod).maybeSingle();
      if(cResp.error){ log('WARN: credenciais falhou — '+cResp.error.message); }
      else if(cResp.data){ descricao = cResp.data.descricao; }
    }

    // 7) preencher UI (igual ao código de produção)
    const emp = empResp.data;
    const hoje = new Date(); const H = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
    let ativo=false, validadeFmt='—';
    if(emp.validade){
      const [y,m,d]=emp.validade.split('-').map(Number);
      const V = new Date(y, m-1, d);
      validadeFmt = `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;
      ativo = (emp.status==='Ativo') && (V>=H);
    }
    $('#nome').textContent = emp.nome||'—';
    $('#registro').textContent = emp.registro||'—';
    $('#crednum').textContent = emp.cred_num||'—';
    $('#cargo').textContent = emp.cargo||'—';
    $('#unidade').textContent = emp.nome_da_unidade ? `${emp.nome_da_unidade} (${emp.sigla})` : (emp.sigla||'—');
    $('#desc').textContent = descricao||'—';
    const st = $('#statusChip'); st.textContent = ativo ? 'ATIVO' : 'INATIVO'; st.className = 'chip ' + (ativo ? 'ativo' : 'inativo');
    $('#validadeChip').textContent = `Validade: ${validadeFmt}`;
    const fotoEl = $('#foto');
    if(emp.foto_path){ fotoEl.src = `${cfg.supabaseUrl}/storage/v1/object/public/${emp.foto_path}`; fotoEl.onerror = ()=>{ fotoEl.src='https://via.placeholder.com/120x120?text=sem+foto'; }; }
    else { fotoEl.src='https://via.placeholder.com/120x120?text=sem+foto'; }

    $('#loading').classList.add('hidden');
    $('#card').classList.remove('hidden');
    console.log('OK FINAL: renderizado');
  } catch(e){
    console.error('DIAG EXCEPTION', e);
  }
</script>

</body>
</html>
