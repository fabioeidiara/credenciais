<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Credencial do Agente – CETESB</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="style.css" rel="stylesheet">
  <meta name="color-scheme" content="light">
</head>
<body>

<header class="header">
  <div class="container">
    <div class="brand">
      <img src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1>CETESB – Credencial do Agente</h1>
    </div>
    <div class="actions">
      <a class="btn ghost" href="index.html">Área restrita</a>
    </div>
  </div>
</header>

<main class="container">
  <div id="card" class="card pad hidden">
    <div class="qr-card">
      <img id="foto" class="avatar" src="" alt="Foto do agente">
      <div>
        <h2 id="nome">—</h2>
        <p class="muted" id="desc">—</p>
        <div class="row mt-8">
          <span id="statusChip" class="chip">Status</span>
          <span id="validadeChip" class="chip">Validade</span>
        </div>

        <div class="row mt-12">
          <span class="badge">Dados essenciais</span>
        </div>
        <div class="row">
          <div class="label">Nº da credencial:</div><div id="crednum">—</div>
        </div>
        <div class="row">
          <div class="label">Registro:</div><div id="registro">—</div>
        </div>
        <div class="row">
          <div class="label">Cargo:</div><div id="cargo">—</div>
        </div>
        <div class="row">
          <div class="label">Unidade:</div><div id="unidade">—</div>
        </div>
      </div>
    </div>
  </div>

  <div id="loading" class="alert mt-16">
    <div><strong>Carregando…</strong> Aguarde um instante.</div>
  </div>

  <div id="notfound" class="alert error mt-16 hidden">
    <div>
      <strong>Registro não encontrado ou credencial inativa.</strong>
      <div class="small">Verifique o número ou entre em contato com a CETESB.</div>
    </div>
  </div>

  <p class="footer">Confirme o domínio: <strong>*.github.io</strong> (piloto) ou <strong>*.cetesb.sp.gov.br</strong> (produção).</p>
</main>

<script type="module">
  const $ = (s)=>document.querySelector(s);
  const show = (el, v=true)=> el.classList.toggle('hidden', !v);

  // Utilitário: exibir erro visível
  function fail(msg){
    $('#loading').innerHTML = `<div><strong>${msg}</strong></div>`;
  }

  // 1) Carregar config.json (caminho relativo!)
  let cfg;
  try {
    const res = await fetch('config.json', { cache:'no-store' });
    if(!res.ok) throw new Error(`config.json HTTP ${res.status}`);
    cfg = await res.json();
  } catch (e) {
    fail('Falha ao carregar configuração (config.json).');
    console.error(e);
    throw e;
  }

  // 2) Importar Supabase com fallback de CDN
  let createClient;
  try {
    ({ createClient } = await import('https://esm.sh/@supabase/supabase-js@2'));
  } catch(e1){
    console.warn('esm.sh falhou, tentando jsdelivr…', e1);
    try {
      ({ createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'));
    } catch(e2){
      fail('Falha ao carregar SDK do Supabase.');
      console.error(e2);
      throw e2;
    }
  }

  // 3) Validar parâmetro ?reg=
  const params = new URLSearchParams(location.search);
  const reg = (params.get('reg')||'').trim();
  if(!/^\d{6}$/.test(reg)){
    fail('Parâmetro inválido. Use ?reg=000001 (6 dígitos).');
    throw new Error('reg inválido');
  }

  // 4) Consultar no Supabase
  const supabase = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);
  const { data, error } = await supabase
    .from('empregados')
    .select('registro,cred_num,validade,status,nome,cargo,sigla,nome_da_unidade,credenciais(descricao),foto_path')
    .eq('registro', reg)
    .maybeSingle();

  if (error) {
    fail('Erro ao consultar a credencial. Tente novamente mais tarde.');
    console.error(error);
    throw error;
  }

  if (!data) {
    show($('#loading'), false);
    show($('#notfound'), true);
    return;
  }

  // 5) Calcular status/validade
  const hoje = new Date(); const H = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
  let ativo = false, validadeFmt = '—';
  if (data.validade) {
    const [y,m,d] = data.validade.split('-').map(Number);
    const V = new Date(y, m-1, d);
    validadeFmt = `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;
    ativo = (data.status === 'Ativo') && (V >= H);
  }
  const statusPublico = ativo ? 'ATIVO' : 'INATIVO';

  // 6) Preencher UI
  $('#nome').textContent = data.nome || '—';
  $('#registro').textContent = data.registro || '—';
  $('#crednum').textContent = data.cred_num || '—';
  $('#cargo').textContent = data.cargo || '—';
  $('#unidade').textContent = data.nome_da_unidade ? `${data.nome_da_unidade} (${data.sigla})` : (data.sigla || '—');
  $('#desc').textContent = data.credenciais?.descricao || '—';

  const st = $('#statusChip');
  st.textContent = statusPublico;
  st.className = 'chip ' + (ativo ? 'ativo' : 'inativo');

  $('#validadeChip').textContent = `Validade: ${validadeFmt}`;

  const fotoEl = $('#foto');
  if (data.foto_path) {
    fotoEl.src = `${cfg.supabaseUrl}/storage/v1/object/public/${data.foto_path}`;
    fotoEl.onerror = () => { fotoEl.src = 'https://via.placeholder.com/120x120?text=sem+foto'; };
  } else {
    fotoEl.src = 'https://via.placeholder.com/120x120?text=sem+foto';
  }

  show($('#loading'), false);
  show($('#card'), true);
</script>

</body>
</html>
