<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Credencial do Agente – CETESB</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="style.css" rel="stylesheet">
  <meta name="color-scheme" content="light">
</head>
<body>

<header class="header">
  <div class="container">
    <div class="brand">
      <img src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1>CETESB – Credencial do Agente</h1>
    </div>
    <div class="actions">
      <a class="btn ghost" href="index.html">Área restrita</a>
    </div>
  </div>
</header>

<main class="container public-center">
  <div id="card" class="card pad hidden">
    <div class="qr-card">
      <img id="foto" class="avatar" src="" alt="Foto do agente">
      <div>
        <h2 id="nome">—</h2>
        <p class="muted" id="desc">—</p>

        <div class="row mt-8">
          <span id="statusChip" class="chip">Status</span>
          <span id="validadeChip" class="chip">Validade</span>
        </div>

        <div class="row mt-12">
          <span class="badge">Dados essenciais</span>
        </div>
        <div class="row">
          <div class="label">Nº da credencial:</div><div id="crednum">—</div>
        </div>
        <div class="row">
          <div class="label">Registro:</div><div id="registro">—</div>
        </div>
        <div class="row">
          <div class="label">Unidade:</div><div id="unidade">—</div>
        </div>
      </div>
    </div>
  </div>

  <div id="loading" class="alert mt-16">
    <div><strong>Carregando…</strong> Aguarde um instante.</div>
  </div>

  <div id="notfound" class="alert error mt-16 hidden">
    <div>
      <strong>Registro não encontrado ou credencial inativa.</strong>
      <div class="small">Verifique o número ou entre em contato com a CETESB.</div>
    </div>
  </div>

  <p class="footer">Confirme o domínio: <strong>*.github.io</strong> (piloto) ou <strong>*.cetesb.sp.gov.br</strong> (produção).</p>
</main>

<script type="module">
(async () => {
  const $ = (s)=>document.querySelector(s);
  const show = (el, v=true)=> el.classList.toggle('hidden', !v);
  const fail = (msg)=>{ $('#loading').innerHTML = `<div><strong>${msg}</strong></div>`; };

  try {
    // 1) config.json
    let cfg;
    try{
      const res = await fetch('config.json', {cache:'no-store'});
      if(!res.ok) throw new Error('config.json HTTP '+res.status);
      cfg = await res.json();
    }catch(e){ fail('Falha ao carregar configuração (config.json).'); console.error(e); return; }

    // 2) SDK Supabase
    let createClient;
    try{
      ({ createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'));
    }catch(e2){
      fail('Falha ao carregar SDK do Supabase.'); console.error(e2); return;
    }

    // 3) validar ?reg=
    const reg = (new URLSearchParams(location.search).get('reg')||'').trim();
    if(!/^\d{6}$/.test(reg)){ fail('Parâmetro inválido. Use ?reg=000001'); return; }

    // 4) consultar empregado (SEM colunas removidas)
    const supabase = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);
    const empResp = await supabase.from('empregados')
      .select('registro,cred_num,validade,status,nome,sigla,nome_da_unidade,cred_cod,foto_path')
      .eq('registro', reg).maybeSingle();

    if(empResp.error){ fail('Erro ao consultar a credencial.'); console.error(empResp.error); return; }
    const emp = empResp.data;
    if(!emp){ show($('#loading'), false); show($('#notfound'), true); return; }

    // 5) buscar descrição da credencial
    let descricao = '—';
    if (emp.cred_cod != null){
      const cResp = await supabase.from('credenciais').select('descricao').eq('cred_cod', emp.cred_cod).maybeSingle();
      if(!cResp.error && cResp.data) descricao = cResp.data.descricao;
    }

    // 6) status/validade
    const hoje = new Date(); const H = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
    let ativo=false, validadeFmt='—';
    if(emp.validade){
      const [y,m,d]=emp.validade.split('-').map(Number);
      const V = new Date(y, m-1, d);
      validadeFmt = `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;
      ativo = (emp.status==='Ativo') && (V>=H);
    }

    // 7) preencher UI
    $('#nome').textContent = emp.nome||'—';
    $('#registro').textContent = emp.registro||'—';
    $('#crednum').textContent = emp.cred_num||'—';
    $('#unidade').textContent = emp.nome_da_unidade ? `${emp.nome_da_unidade} (${emp.sigla})` : (emp.sigla||'—');
    $('#desc').textContent = descricao||'—';

    const st = $('#statusChip');
    st.textContent = ativo ? 'ATIVO' : 'INATIVO';
    st.className = 'chip ' + (ativo ? 'ativo' : 'inativo');

    $('#validadeChip').textContent = `Validade: ${validadeFmt}`;

    const fotoEl = $('#foto');
    if(emp.foto_path){
      fotoEl.src = `${cfg.supabaseUrl}/storage/v1/object/public/${emp.foto_path}`;
      fotoEl.onerror = ()=>{ fotoEl.src='https://via.placeholder.com/120x120?text=sem+foto'; };
    } else {
      fotoEl.src='https://via.placeholder.com/120x120?text=sem+foto';
    }

    show($('#loading'), false);
    show($('#card'), true);
  } catch (err) {
    console.error(err);
    fail('Falha inesperada ao renderizar a página.');
  }
})();
</script>
</body>
</html>
