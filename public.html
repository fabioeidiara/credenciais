<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Credencial do Agente – CETESB</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="style.css?v=240" rel="stylesheet">
  <meta name="color-scheme" content="light">
</head>
<body>

<header class="header">
  <div class="container">
    <div class="brand">
      <img src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1>CETESB – Credencial do Agente</h1>
    </div>
    <div class="actions">
      <a class="btn" href="index.html">Início</a>
    </div>
  </div>
</header>

<main class="container public-center">
  <div id="card" class="card pad hidden">
    <div class="grid grid-2" style="grid-template-columns:160px 1fr">
      <div class="col">
        <img id="foto" alt="Foto do agente" width="120" height="120"
             style="border-radius:8px;object-fit:cover;border:1px solid #ddd">
      </div>
      <div class="col">
        <h2 id="nome">—</h2>
        <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
          <div class="muted">Registro:</div>
          <div id="registro">—</div>
          <div id="chipStatus" class="chip">—</div>
        </div>

        <hr>
        <div class="row"><div class="label">Credencial:</div><div id="credencial">—</div></div>
        <div class="row"><div class="label">Validade:</div><div id="validade">—</div></div>
        <div class="row"><div class="label">Unidade:</div><div id="unidade">—</div></div>
      </div>
    </div>
  </div>

  <div id="loading" class="alert"><div><strong>Carregando…</strong> Aguarde um instante.</div></div>
  <div id="notfound" class="alert error hidden"><div><strong>Registro não encontrado.</strong> Verifique o número ou entre em contato com a CETESB.</div></div>

  <p class="footer">Confirme o domínio: <strong>*.github.io</strong> (piloto) ou <strong>*.cetesb.sp.gov.br</strong> (produção).</p>
</main>

<script type="module">
(async () => {
  const $  = (s)=>document.querySelector(s);
  const qs = (k)=> new URL(location.href).searchParams.get(k);
  const show = (el, on)=> el?.classList[on ? 'remove' : 'add']('hidden');
  const formatData = (iso)=> iso ? new Date(iso).toLocaleDateString('pt-BR') : '';

  // Placeholder embutido
  const PH120 = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%25' height='100%25' fill='%23e5e7eb'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='12' fill='%2364748b'>sem foto</text></svg>";
  $('#foto').src = PH120;

  // ?reg=000001
  const reg = qs('reg');
  if(!/^\d{6}$/.test(reg||'')){ $('#loading').innerHTML='<div><strong>Parâmetro inválido.</strong> Use ?reg=000001</div>'; return; }

  // Config
  let cfg;
  try{
    const res = await fetch('config.json',{cache:'no-store'});
    if(!res.ok) throw new Error(`config.json HTTP ${res.status}`);
    const txt = await res.text();
    try{ cfg = JSON.parse(txt); } catch(e){ console.error('config.json inválido:', txt); alert('config.json inválido'); return; }
  }catch(e){ console.error('Falha ao carregar config.json', e); alert('Falha ao carregar config.json'); return; }

  // Supabase
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  const supabase = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);

  const normalizeFotoPath = (p)=> String(p||'').replace(/^fotos\//i,'');
  const buildFotoUrl = (fp)=>{
    if(!fp) return null;
    const bucket = (cfg.storageBucket || 'fotos');
    const path = normalizeFotoPath(fp);
    const { data } = supabase.storage.from(bucket).getPublicUrl(path);
    return data?.publicUrl || null;
  };

  // Dados
  const empQ = supabase.from('empregados')
    .select('registro,nome,sigla,nome_da_unidade,cred_cod,cred_num,validade,status,foto_path')
    .eq('registro', reg).maybeSingle();

  const crQ  = supabase.from('credenciais').select('cred_cod,descricao');

  const [{ data: emp, error: eEmp }, { data: catCred }] = await Promise.all([empQ, crQ]);

  if(eEmp){ console.error(eEmp); $('#loading').innerHTML='<div>Erro ao carregar dados.</div>'; return; }
  if(!emp){ show($('#loading'), false); show($('#notfound'), true); return; }

  const mapCred = Object.fromEntries((catCred||[]).map(x=>[String(x.cred_cod), x.descricao]));
  const credDesc = mapCred[String(emp.cred_cod)] || `Tipo ${emp.cred_cod}`;

  $('#nome').textContent = emp.nome || '—';
  $('#registro').textContent = emp.registro || '—';
  $('#credencial').textContent = `${credDesc}${emp.cred_num ? ' • Nº ' + emp.cred_num : ''}`;
  $('#validade').textContent = formatData(emp.validade);
  $('#unidade').textContent  = emp.nome_da_unidade ? `${emp.sigla} – ${emp.nome_da_unidade}` : (emp.sigla || '—');

  const chip = $('#chipStatus');
  const hoje0 = new Date(); hoje0.setHours(0,0,0,0);
  let cls = 'chip', label = '—';
  if (emp.status==='Em andamento'){ cls+=' warn'; label='Em andamento'; }
  else if (emp.status==='Ativo' && emp.validade && new Date(emp.validade) >= hoje0){ cls+=' success'; label='Ativo'; }
  else { cls+=' danger'; label='Inativo/Vencido'; }
  chip.className = cls; chip.textContent = label;

  const url = buildFotoUrl(emp.foto_path);
  $('#foto').src = url || PH120;

  show($('#loading'), false);
  show($('#card'), true);
})();
</script>
</body>
</html>
