<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Credencial do Agente – CETESB</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="style.css?v=242" rel="stylesheet">
  <meta name="color-scheme" content="light">
  <link rel="icon" href="data:,">
  <style>
    /* Polimento: rótulo x valor bem distintos */
    .kv { display:grid; grid-template-columns:120px 1fr; gap:6px 12px; align-items:center; }
    .kv .k { color:#64748b; font-weight:700; }
    .kv .v { color:#1e293b; font-weight:700; }
    @media (max-width:560px){ .kv{grid-template-columns:1fr} .kv .k{margin-top:8px} }
  </style>
</head>
<body>

<header class="header">
  <div class="container">
    <div class="brand">
      <img src="media/cetesb-logo.png" alt="CETESB" onerror="this.style.display='none'">
      <h1>CETESB – Credencial do Agente</h1>
    </div>
    <div class="actions">
      <a class="btn" href="index.html">Início</a>
    </div>
  </div>
</header>

<main class="container public-center">
  <div id="card" class="card pad hidden">
    <div class="grid grid-2" style="grid-template-columns:160px 1fr">
      <div class="col">
        <img id="foto" alt="Foto do agente" width="120" height="120"
             style="border-radius:8px;object-fit:cover;border:1px solid #ddd">
      </div>
      <div class="col">
        <h2 id="nome" style="margin:0 0 6px">—</h2>
        <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px">
          <span class="k muted">Registro</span>
          <span id="registro" class="v">—</span>
          <span id="chipStatus" class="chip">—</span>
        </div>

        <div class="kv">
          <div class="k">Credencial</div><div id="credencial" class="v">—</div>
          <div class="k">Validade</div><div id="validade" class="v">—</div>
          <div class="k">Unidade</div><div id="unidade" class="v">—</div>
        </div>
      </div>
    </div>
  </div>

  <div id="loading" class="alert"><div><strong>Carregando…</strong> Aguarde um instante.</div></div>
  <div id="notfound" class="alert error hidden"><div><strong>Registro não encontrado.</strong> Verifique o número ou entre em contato com a CETESB.</div></div>

  <p class="footer">Confirme o domínio: <strong>*.github.io</strong> (piloto) ou <strong>*.cetesb.sp.gov.br</strong> (produção).</p>
</main>

<script type="module">
(async function(){
  function $(s){ return document.querySelector(s); }
  function qs(k){ return new URL(location.href).searchParams.get(k); }
  function show(el, on){ if(!el) return; if(on){ el.classList.remove('hidden'); } else { el.classList.add('hidden'); } }
  function fmt(iso){ return iso ? new Date(iso).toLocaleDateString('pt-BR') : ''; }

  // Placeholder embutido
  var PH120 = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%25' height='100%25' fill='%23e5e7eb'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='12' fill='%2364748b'>sem foto</text></svg>";
  $('#foto').src = PH120;

  // ?reg=
  var reg = qs('reg');
  if(!/^\d{6}$/.test(reg||'')){
    $('#loading').innerHTML = '<div><strong>Parâmetro inválido.</strong> Use ?reg=000001</div>';
    return;
  }

  // config.json
  var cfg;
  try{
    var r = await fetch('config.json',{cache:'no-store'});
    if(!r.ok) throw new Error('config.json HTTP '+r.status);
    var txt = await r.text();
    try{ cfg = JSON.parse(txt); }catch(e){ console.error('config.json inválido:', txt); alert('config.json inválido'); return; }
  }catch(e){
    console.error('Falha ao carregar config.json', e);
    alert('Falha ao carregar config.json');
    return;
  }

  // Supabase (import compatível)
  const supa = await import('https://esm.sh/@supabase/supabase-js@2');
  const createClient = supa.createClient;
  var supabase = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);

  function normalizeFotoPath(p){ return String(p||'').replace(/^fotos\//i,''); }
  async function getFotoUrl(fp){
    if(!fp) return null;
    var bucket = cfg.storageBucket || 'fotos';
    var path = normalizeFotoPath(fp);

    var signed = await supabase.storage.from(bucket).createSignedUrl(path, 3600);
    if(signed && !signed.error && signed.data && signed.data.signedUrl) return signed.data.signedUrl;

    var pub = supabase.storage.from(bucket).getPublicUrl(path);
    if(pub && pub.data && pub.data.publicUrl) return pub.data.publicUrl;

    return null;
  }

  // Dados
  var empQ = supabase.from('empregados')
    .select('registro,nome,sigla,nome_da_unidade,cred_cod,cred_num,validade,status,foto_path')
    .eq('registro', reg).maybeSingle();

  var crQ  = supabase.from('credenciais').select('cred_cod,descricao');

  var arr = await Promise.all([empQ, crQ]);
  var emp = arr[0].data, eEmp = arr[0].error;
  var catCred = arr[1].data;

  if(eEmp){
    console.error(eEmp);
    $('#loading').innerHTML = '<div>Erro ao carregar dados.</div>';
    return;
  }
  if(!emp){
    show($('#loading'), false);
    show($('#notfound'), true);
    return;
  }

  // Mapa de credenciais
  var mapCred = {};
  (catCred||[]).forEach(function(x){ mapCred[String(x.cred_cod)] = x.descricao; });
  var credDesc = mapCred[String(emp.cred_cod)] || ('Tipo '+emp.cred_cod);

  // Preenche
  $('#nome').textContent      = emp.nome || '—';
  $('#registro').textContent  = emp.registro || '—';
  $('#credencial').textContent= credDesc + (emp.cred_num ? ' • Nº '+emp.cred_num : '');
  $('#validade').textContent  = fmt(emp.validade);
  $('#unidade').textContent   = emp.nome_da_unidade ? (emp.sigla+' – '+emp.nome_da_unidade) : (emp.sigla || '—');

  // Status
  var chip = $('#chipStatus');
  var hoje0 = new Date(); hoje0.setHours(0,0,0,0);
  var ativoValido = (emp.status==='Ativo' && emp.validade && new Date(emp.validade) >= hoje0);
  chip.className = 'chip ' + (emp.status==='Em andamento' ? 'warn' : (ativoValido ? 'success' : 'danger'));
  chip.textContent = (emp.status==='Em andamento' ? 'Em andamento' : (ativoValido ? 'Ativo' : 'Inativo/Vencido'));

  // Foto (pública/assinada)
  var url = await getFotoUrl(emp.foto_path);
  $('#foto').src = url || PH120;

  // Mostrar
  show($('#loading'), false);
  show($('#card'), true);
})();
</script>
</body>
</html>
